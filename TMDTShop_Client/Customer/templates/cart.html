<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - ShopX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" type="image/png" href="/Customer/assets/images/logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        /* --- Quantity Controls --- */
        .quantity-input {
            width: 3.5rem;
            /* w-14 */
            text-align: center;
            border-top: 1px solid #d1d5db;
            /* gray-300 */
            border-bottom: 1px solid #d1d5db;
            /* gray-300 */
            /* Loại bỏ border trái/phải để liền mạch với nút */
            border-left: none;
            border-right: none;
            padding-left: 0.25rem;
            /* px-1 */
            padding-right: 0.25rem;
            /* px-1 */
            appearance: textfield;
            /* Firefox */
            -moz-appearance: textfield;
            /* Firefox */
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-btn {
            background-color: #f3f4f6;
            /* gray-100 */
            border: 1px solid #d1d5db;
            /* gray-300 */
            padding: 0.5rem 0.75rem;
            /* py-2 px-3 */
            font-weight: 600;
            /* font-semibold */
            color: #374151;
            /* gray-700 */
            transition: background-color 0.15s ease-in-out;
        }

        .quantity-btn:hover:not(:disabled) {
            background-color: #e5e7eb;
            /* gray-200 */
        }

        .quantity-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Cart Item --- */
        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.375rem;
            /* rounded-md */
            border: 1px solid #e5e7eb;
            /* gray-200 */
        }

        .product-item-container.unavailable,
        .product-item-container.out-of-stock {
            opacity: 0.65;
            position: relative;
        }

        /* Thông báo thay thế checkbox */
        .item-status-notice {
            font-size: 0.75rem;
            /* text-xs */
            font-weight: 500;
            /* font-medium */
            padding: 0.125rem 0.5rem;
            /* py-0.5 px-2 */
            border-radius: 9999px;
            /* rounded-full */
            display: inline-block;
            white-space: nowrap;
        }

        .item-status-hidden {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        /* gray-200, gray-600 */
        .item-status-out-of-stock {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        /* red-100, red-700 */


        /* --- General Loader --- */
        .loader {
            border: 4px solid #f3f3f3;
            /* gray-100 */
            border-top: 4px solid #4f46e5;
            /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- Custom Checkbox (Tailwind Forms Plugin like) --- */
        .form-checkbox {
            appearance: none;
            padding: 0;
            print-color-adjust: exact;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            height: 1.25rem;
            width: 1.25rem;
            color: #4f46e5;
            /* indigo-600 */
            background-color: #fff;
            border-color: #6b7280;
            /* gray-500 */
            border-width: 1px;
            border-radius: 0.25rem;
            /* rounded */
        }

        .form-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            border-color: transparent;
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }

        .form-checkbox:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-offset-width: 2px;
            --tw-ring-color: rgba(79, 70, 229, 0.5);
            /* indigo-600 with opacity */
            box-shadow: 0 0 0 var(--tw-ring-offset-width) #fff, 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
        }

        .form-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #d1d5db;
            /* gray-300 */
            background-color: #f3f4f6;
            /* gray-100 */
        }

        .form-checkbox:disabled:checked {
            /* Style khi disabled và checked (hiếm khi xảy ra nếu logic đúng) */
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='%239ca3af' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            /* Màu tick xám */
            background-color: #e5e7eb;
            /* gray-200 */
        }


        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            /* Tăng độ mờ */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            /* Delay visibility transition */
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            /* shadow-2xl */
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(-20px) scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
        }

        .modal-close-btn:hover {
            color: #1f2937;
        }

        .discount-item-modal {
            border: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .discount-item-modal:hover {
            background-color: #f9fafb;
            border-color: #6366f1;
        }

        /* indigo-500 */
        .discount-item-modal.selected-discount {
            background-color: #e0e7ff;
            /* indigo-100 */
            border-color: #4f46e5;
            /* indigo-600 */
        }

        .discount-item-modal .discount-code {
            font-weight: 600;
            color: #3730a3;
        }

        /* indigo-800 */
        .discount-item-modal .discount-percent {
            font-size: 0.875rem;
            color: #16a34a;
        }

        /* green-600 */
        .discount-item-modal .discount-expiry {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.125rem;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <div id="header-container"></div>

    <main id="mainContent" class="container mx-auto px-4 py-8">
        <section class="bg-white p-4 md:p-8 rounded-lg shadow-xl">
            <nav class="text-sm mb-6" aria-label="Breadcrumb">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a href="index.html" class="text-gray-500 hover:text-indigo-600">Trang chủ</a>
                        <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
                    </li>
                    <li class="flex items-center"><span class="text-gray-700 font-medium">Giỏ hàng</span></li>
                </ol>
            </nav>

            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Giỏ hàng của bạn</h1>

            <div id="cartLoading" class="text-center py-10">
                <div class="loader mx-auto"></div>
                <p class="text-gray-600 mt-2">Đang tải giỏ hàng...</p>
            </div>

            <div id="cartContent" class="hidden">
                <div id="emptyCartMessage" class="text-center py-16 hidden">
                    <i class="fas fa-shopping-bag fa-4x text-gray-300 mb-6"></i>
                    <p class="text-xl text-gray-700 mb-3">Giỏ hàng của bạn còn trống</p>
                    <p class="text-gray-500 mb-6">Hãy lựa chọn những sản phẩm tuyệt vời nào!</p>
                    <a href="index.html"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
                        Khám phá sản phẩm
                    </a>
                </div>

                <div id="cartHasItems">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b pb-3">
                        <label class="inline-flex items-center cursor-pointer mb-2 sm:mb-0">
                            <input type="checkbox" id="selectAllCheckbox" class="form-checkbox">
                            <span class="ml-2 text-gray-700 font-medium">Chọn tất cả (<span
                                    id="totalCartItemsCount">0</span> sản
                                phẩm)</span>
                        </label>
                        <button id="clearSelectedItemsBtn"
                            class="text-sm text-red-500 hover:text-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium flex items-center"
                            disabled>
                            <i class="fas fa-trash-alt mr-1"></i> Xóa mục đã chọn
                        </button>
                    </div>

                    <div id="cartItemsContainer" class="divide-y divide-gray-200">
                        <!-- Cart items rendered here -->
                    </div>

                    <div id="cartSummary" class="mt-8 pt-6 border-t border-gray-300">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Thông tin thanh toán</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="shippingAddressInput"
                                    class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ giao hàng
                                    <span class="text-red-500">*</span></label>
                                <input type="text" id="shippingAddressInput"
                                    placeholder="Ví dụ: 123 Đường ABC, Phường XYZ, Quận 1, TP.HCM"
                                    class="p-3 border border-gray-300 rounded-md w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <p id="shippingAddressError" class="text-red-500 text-xs mt-1 hidden"></p>
                            </div>
                            <div>
                                <label for="discountCodeInput" class="block text-sm font-medium text-gray-700 mb-1">Mã
                                    giảm giá</label>
                                <div class="flex items-center">
                                    <input type="text" id="discountCodeInput"
                                        placeholder="Nhập mã hoặc chọn từ danh sách" readonly
                                        class="p-3 border border-gray-300 rounded-l-md w-full shadow-sm bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500">
                                    <button id="openDiscountModalBtn" type="button"
                                        class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-3 rounded-r-md font-medium transition flex-shrink-0">
                                        <i class="fas fa-tags mr-1.5"></i> Chọn mã
                                    </button>
                                </div>
                                <p id="discountMessage" class="text-xs mt-1"></p>
                            </div>
                        </div>

                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2 text-gray-700">
                                <span>Số sản phẩm đã chọn:</span>
                                <span id="selectedItemsCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between items-center mb-1 text-gray-700">
                                <span>Tạm tính:</span>
                                <span id="subtotalPrice" class="font-semibold">0đ</span>
                            </div>
                            <div class="flex justify-between items-center mb-3 text-sm text-green-600">
                                <span id="discountAppliedText">Giảm giá:</span>
                                <span id="discountAmount" class="font-semibold">-0đ</span>
                            </div>
                            <div
                                class="flex justify-between items-center text-xl font-bold text-gray-800 border-t pt-3 mt-3">
                                <span>Tổng cộng:</span>
                                <span id="selectedCartPrice" class="text-red-600">0đ</span>
                            </div>
                        </div>

                        <div class="mt-8 flex flex-col sm:flex-row justify-end gap-3">
                            <a href="index.html"
                                class="w-full sm:w-auto px-6 py-3 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-100 transition duration-150 font-medium">
                                Tiếp tục mua sắm
                            </a>
                            <button id="checkoutSelectedButton"
                                class="w-full sm:w-auto px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-lg"
                                disabled>
                                Thanh toán (<span id="checkoutButtonSelectedCount">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-container"></div>

    <!-- Discount Code Modal -->
    <div id="discountModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeDiscountModalBtn" class="modal-close-btn" aria-label="Đóng modal">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Chọn Mã Giảm Giá</h3>
            <div id="discountModalLoading" class="text-center py-5">
                <div class="loader mx-auto"></div>
            </div>
            <div id="discountModalListContainer" class="hidden"> <!-- Container cho list và no-message -->
                <div id="discountModalList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Discount items will be populated here -->
                </div>
                <div id="noDiscountsMessageModal" class="hidden text-center text-gray-500 py-5">
                    Hiện không có mã giảm giá nào phù hợp.
                </div>
            </div>
            <button id="applySelectedDiscountBtn"
                class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 px-4 rounded-md transition disabled:opacity-50"
                disabled>
                Áp dụng mã đã chọn
            </button>
        </div>
    </div>


    <script src="../assets/js/index.js"></script>
    <script type="module" src="../assets/js/components.js"></script>
    <script>
        function initializeCustomerCartPage() {
            // ... (Khai báo DOM elements giữ nguyên)
            const cartLoadingEl = document.getElementById('cartLoading');
            const cartContentEl = document.getElementById('cartContent');
            const cartItemsContainerEl = document.getElementById('cartItemsContainer');
            const emptyCartMessageEl = document.getElementById('emptyCartMessage');
            const cartHasItemsEl = document.getElementById('cartHasItems');
            const cartSummaryEl = document.getElementById('cartSummary');
            const totalCartItemsCountEl = document.getElementById('totalCartItemsCount');
            const selectedItemsCountEl = document.getElementById('selectedItemsCount');
            const subtotalPriceEl = document.getElementById('subtotalPrice');
            const discountAppliedTextEl = document.getElementById('discountAppliedText');
            const discountAmountEl = document.getElementById('discountAmount');
            const selectedCartPriceEl = document.getElementById('selectedCartPrice');
            const checkoutSelectedButton = document.getElementById('checkoutSelectedButton');
            const checkoutButtonSelectedCount = document.getElementById('checkoutButtonSelectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const clearSelectedItemsBtn = document.getElementById('clearSelectedItemsBtn');
            const shippingAddressInput = document.getElementById('shippingAddressInput');
            const discountCodeInput = document.getElementById('discountCodeInput');
            const discountMessageEl = document.getElementById('discountMessage');
            const shippingAddressError = document.getElementById('shippingAddressError');
            const discountModal = document.getElementById('discountModal');
            const openDiscountModalBtn = document.getElementById('openDiscountModalBtn');
            const closeDiscountModalBtn = document.getElementById('closeDiscountModalBtn');
            const discountModalLoading = document.getElementById('discountModalLoading');
            const discountModalListContainer = document.getElementById('discountModalListContainer');
            const discountModalList = document.getElementById('discountModalList');
            const noDiscountsMessageModal = document.getElementById('noDiscountsMessageModal');
            const applySelectedDiscountBtn = document.getElementById('applySelectedDiscountBtn');

            let currentCartData = null;
            let appliedDiscountDetails = null;
            let selectedDiscountInModal = null;

            if (typeof formatDate !== 'function' || typeof formatCurrency !== 'function' || typeof getSession !== 'function' || typeof API_BASE_URL === 'undefined' || typeof getImageUrl !== 'function') {
                console.error("Một số hàm hoặc biến toàn cục từ index.js chưa sẵn sàng.");
                cartLoadingEl.innerHTML = '<p class="text-red-500 text-center">Lỗi tải trang. Vui lòng thử lại.</p>';
                return;
            }

            const ORDER_STATUSES = Object.freeze({ /* ... (giữ nguyên) ... */ }); // Chỉ cần nếu bạn có logic liên quan trạng thái ở đây

            function getStatusClass(status) { /* ... (giữ nguyên) ... */ } // Có thể không cần trong cart.html

            function renderCartItem(item) {
                const imageUrl = window.getImageUrl(item.imageURL);
                const priceFormatted = window.formatCurrency(item.price);

                let itemClasses = "py-5 flex flex-col sm:flex-row items-start gap-4 product-item-container";
                let checkboxReplacementHtml = '';
                let quantityControlsDisabled = false;
                let quantityInputValue = item.quantity;
                let maxQuantity = item.availableStock;
                let isActuallyUnavailableForPurchase = false;
                let productNameClasses = "text-md lg:text-lg font-semibold text-gray-800 hover:text-indigo-600 block mb-1 truncate";
                let priceClasses = "text-md font-medium text-red-500 mt-1";
                let lineTotalClasses = "text-md lg:text-lg font-semibold text-gray-700 w-full sm:w-auto text-left sm:text-right sm:min-w-[120px] mt-2 sm:mt-0";


                if (!item.isActive) {
                    itemClasses += " unavailable";
                    checkboxReplacementHtml = `<span class="item-status-notice item-status-hidden" title="Sản phẩm đã bị ẩn">Đã ẩn</span>`;
                    quantityControlsDisabled = true;
                    quantityInputValue = 0;
                    isActuallyUnavailableForPurchase = true;
                    productNameClasses += " line-through text-gray-400 no-event";
                    priceClasses += " line-through text-gray-400";
                    lineTotalClasses += " line-through text-gray-400";
                } else if (item.availableStock === 0) {
                    itemClasses += " out-of-stock";
                    checkboxReplacementHtml = `<span class="item-status-notice item-status-out-of-stock" title="Sản phẩm đã hết hàng">Hết hàng</span>`;
                    quantityControlsDisabled = true; // Không cho thay đổi SL nếu đã hết sạch
                    // Giữ quantityInputValue nếu người dùng đã có trong giỏ, để họ có thể xóa
                    isActuallyUnavailableForPurchase = true;
                } else if (item.quantity > item.availableStock) {
                    quantityInputValue = item.availableStock;
                }

                const lineTotalForItem = item.price * quantityInputValue;

                return `
                    <div class="${itemClasses}" 
                         data-cart-item-id="${item.cartItemID}" 
                         data-product-id="${item.productID}" 
                         data-price="${item.price}" 
                         data-stock="${item.availableStock}" 
                         data-is-active="${item.isActive}"
                         data-is-unavailable-for-purchase="${isActuallyUnavailableForPurchase}">
                        <div class="flex items-center w-full sm:w-auto ${!item.isActive ? 'pointer-events-none' : ''}">
                             ${checkboxReplacementHtml ?
                        `<div class="h-5 mr-4 flex-shrink-0 flex items-center justify-center">${checkboxReplacementHtml}</div>`
                        :
                        `<input type="checkbox" class="cart-item-checkbox form-checkbox mr-4 flex-shrink-0" 
                                   data-item-id="${item.cartItemID}">`
                    }
                            <img src="${imageUrl}" alt="${item.productName}" class="cart-item-image">
                        </div>
                        <div class="flex-grow min-w-0">
                            <a href="${item.isActive ? `product-detail.html?productId=${item.productID}` : 'javascript:void(0);'}" 
                               class="${productNameClasses}" 
                               title="${item.productName}">${item.productName}</a>
                            
                            ${item.isActive && item.availableStock > 0 ?
                        `<p class="text-sm text-gray-500">Tồn kho: ${item.availableStock}</p>` :
                        (item.isActive && item.availableStock === 0 && !checkboxReplacementHtml ? `<p class="text-sm text-red-500 font-medium">Hết hàng</p>` : '')
                    }
                            
                            <p class="${priceClasses}">${priceFormatted}</p>
                        </div>

                        <div class="flex items-center ${quantityControlsDisabled || !item.isActive ? 'opacity-50 pointer-events-none' : ''}">
                            <button class="quantity-btn decrease-quantity rounded-l-md"
                                    data-item-id="${item.cartItemID}"
                                    aria-label="Giảm số lượng" ${quantityControlsDisabled || !item.isActive || quantityInputValue <= (item.availableStock === 0 && item.isActive ? 0 : 1) ? 'disabled' : ''}>
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" value="${quantityInputValue}" 
                                   min="${item.isActive && item.availableStock > 0 ? 1 : 0}"
                                   max="${maxQuantity}"
                                class="quantity-input update-quantity-input text-center w-14 border-gray-200 border-t border-b py-2 px-0 
                                        focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 
                                        form-input focus:z-10"
                                data-item-id="${item.cartItemID}"
                                aria-label="Số lượng sản phẩm" ${quantityControlsDisabled || !item.isActive ? 'disabled' : ''}>
                            <button class="quantity-btn increase-quantity rounded-r-md"
                                    data-item-id="${item.cartItemID}"
                                    aria-label="Tăng số lượng" ${quantityControlsDisabled || !item.isActive || (item.isActive && item.availableStock === 0 && quantityInputValue >= item.availableStock) || quantityInputValue >= maxQuantity ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="${lineTotalClasses}">
                            ${item.isActive ? formatCurrency(lineTotalForItem) : formatCurrency(0)}
                        </div>
                        <div class="text-center sm:text-right mt-2 sm:mt-0 self-start sm:self-center">
                            <button class="text-red-500 hover:text-red-700 remove-item" data-item-id="${item.cartItemID}" title="Xóa sản phẩm">
                                <i class="fas fa-trash-alt fa-fw"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            function renderCart(cartData) {
                currentCartData = cartData;
                cartItemsContainerEl.innerHTML = '';
                // Reset discount khi tải lại giỏ hàng, trừ khi nó được giữ lại từ session/local storage
                // appliedDiscountDetails = null; 
                // discountCodeInput.value = appliedDiscountDetails ? appliedDiscountDetails.code : '';
                // discountMessageEl.textContent = appliedDiscountDetails ? `Đang áp dụng: ${appliedDiscountDetails.code} (-${appliedDiscountDetails.percent}%)` : '';
                // discountMessageEl.className = appliedDiscountDetails ? 'text-xs mt-1 text-green-600' : 'text-xs mt-1';


                if (cartData && cartData.cartItems && cartData.cartItems.length > 0) {
                    var totalItem = 0;
                    cartData.cartItems.forEach(item => {
                        if (item.isActive && item.availableStock > 0) {
                            totalItem++
                            console.log(totalItem)
                            console.log(item)
                        }
                    });
                    totalCartItemsCountEl.textContent = totalItem
                    cartData.cartItems.forEach(item => {
                        cartItemsContainerEl.innerHTML += renderCartItem(item);
                    });
                    emptyCartMessageEl.classList.add('hidden');
                    cartHasItemsEl.classList.remove('hidden');
                    cartSummaryEl.classList.remove('hidden');

                    // Kiểm tra xem có item nào có thể chọn không để enable/disable selectAllCheckbox
                    const canSelectAny = cartData.cartItems.some(item => item.isActive && item.availableStock > 0);
                    selectAllCheckbox.disabled = !canSelectAny;

                } else {
                    totalCartItemsCountEl.textContent = '0';
                    emptyCartMessageEl.classList.remove('hidden');
                    cartHasItemsEl.classList.add('hidden');
                    cartSummaryEl.classList.add('hidden');
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.disabled = true;
                }
                updateSelectedSummary();
                attachEventListeners();
                cartLoadingEl.classList.add('hidden');
                cartContentEl.classList.remove('hidden');
            }

            function handleSelectAllChange() {
                const isChecked = selectAllCheckbox.checked;
                // Chỉ tác động lên các checkbox của item không bị disable (tức là item hợp lệ để chọn)
                document.querySelectorAll('.cart-item-checkbox:not([disabled])').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateSelectedSummary(); // Cập nhật lại tổng tiền và trạng thái các nút
            }

            function attachEventListeners() {
                selectAllCheckbox.removeEventListener('change', handleSelectAllChange);
                selectAllCheckbox.addEventListener('change', handleSelectAllChange);

                cartItemsContainerEl.querySelectorAll('.cart-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', handleCheckboxChange);
                });

                cartItemsContainerEl.querySelectorAll('.decrease-quantity').forEach(button => {
                    button.addEventListener('click', handleQuantityChange);
                });
                cartItemsContainerEl.querySelectorAll('.increase-quantity').forEach(button => {
                    button.addEventListener('click', handleQuantityChange);
                });
                cartItemsContainerEl.querySelectorAll('.update-quantity-input').forEach(input => {
                    input.addEventListener('change', handleQuantityChange);
                });
                cartItemsContainerEl.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', handleRemoveItem);
                });
            }

            function handleCheckboxChange() {
                updateSelectedSummary();
            }

            function handleQuantityChange(event) {
                const triggeredElement = event.target;
                let itemId;
                let quantityInput;
                let actionType;

                if (triggeredElement.dataset.itemId) {
                    itemId = triggeredElement.dataset.itemId;
                    if (triggeredElement.classList.contains('decrease-quantity')) {
                        actionType = 'decrease';
                        quantityInput = triggeredElement.nextElementSibling;
                    } else if (triggeredElement.classList.contains('increase-quantity')) {
                        actionType = 'increase';
                        quantityInput = triggeredElement.previousElementSibling;
                    } else if (triggeredElement.classList.contains('update-quantity-input')) {
                        actionType = 'input';
                        quantityInput = triggeredElement;
                    }
                } else {
                    const button = triggeredElement.closest('.quantity-btn');
                    if (button && button.dataset.itemId) {
                        itemId = button.dataset.itemId;
                        if (button.classList.contains('decrease-quantity')) {
                            actionType = 'decrease';
                            quantityInput = button.nextElementSibling;
                        } else if (button.classList.contains('increase-quantity')) {
                            actionType = 'increase';
                            quantityInput = button.previousElementSibling;
                        }
                    }
                }

                // Nếu không tìm thấy itemId hoặc actionType, thoát sớm
                if (!itemId || !actionType || !quantityInput) {
                    console.error('Lỗi: Không thể xác định itemId, actionType hoặc quantityInput trong handleQuantityChange.', { triggeredElement, itemId, actionType });
                    return;
                }

                const cartItemDiv = document.querySelector(`div[data-cart-item-id="${itemId}"]`);
                if (!cartItemDiv) { /* ... */ return; }

                const isActive = cartItemDiv.dataset.isActive === 'true';
                if (!isActive) return; // Không cho thay đổi SL của sp không active

                const stock = parseInt(cartItemDiv.dataset.stock);
                let newQuantity;

                if (actionType === 'decrease') {
                    newQuantity = parseInt(quantityInput.value) - 1;
                } else if (actionType === 'increase') {
                    newQuantity = parseInt(quantityInput.value) + 1;
                } else if (actionType === 'input') {
                    newQuantity = parseInt(quantityInput.value);
                }

                if (isNaN(newQuantity)) { // Xử lý nếu nhập không phải số
                    newQuantity = 0; // Hoặc quantityInput.value = currentCartData.cartItems.find(i => i.cartItemID == itemId).quantity; (reset về giá trị cũ)
                }

                // Cho phép giảm về 0, nhưng không cho phép âm
                if (newQuantity < 0) {
                    newQuantity = 0;
                }

                // Không cho phép tăng quá số lượng tồn kho
                if (stock > 0 && newQuantity > stock) {
                    alert(`Sản phẩm này chỉ còn tối đa ${stock} sản phẩm trong kho.`);
                    newQuantity = stock;
                } else if (stock === 0 && newQuantity > 0) {
                    // Nếu sản phẩm đã hết hàng (stock=0) nhưng người dùng cố tăng số lượng từ 0
                    alert(`Sản phẩm này đã hết hàng.`);
                    newQuantity = 0; // Giữ nguyên là 0
                }

                quantityInput.value = newQuantity; // Cập nhật UI input

                const currentItemData = currentCartData.cartItems.find(item => item.cartItemID == itemId);
                // Chỉ gọi API nếu số lượng thực sự thay đổi, hoặc nếu là từ input trực tiếp
                if (currentItemData && (currentItemData.quantity !== newQuantity || actionType === 'input')) {
                    // Nếu newQuantity là 0, coi như xóa (hoặc API của bạn xử lý quantity=0 là xóa)
                    if (newQuantity === 0) {
                        removeCartItem(itemId, true); // Xóa ngầm
                    } else {
                        updateCartItemQuantity(itemId, newQuantity);
                    }
                } else if (actionType === 'input' && newQuantity === 0) { // Xử lý khi người dùng nhập trực tiếp số 0
                    removeCartItem(itemId, true);
                }

                updateCartItemQuantity(itemId, newQuantity);
            }

            function handleRemoveItem(event) {
                const itemId = event.target.closest('.remove-item').dataset.itemId;
                removeCartItem(itemId);
            }

            function updateSelectedSummary() {
                const allVisibleAndEnabledCheckboxes = document.querySelectorAll('.cart-item-checkbox:not([disabled])');
                const selectedAndEnabledCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked:not([disabled])');

                let selectedItemsCount = 0;
                let subtotal = 0;
                let canProceedToCheckout = true;

                // Tính toán dựa trên selectedAndEnabledCheckboxes
                selectedAndEnabledCheckboxes.forEach(checkbox => {
                    const itemId = checkbox.dataset.itemId;
                    const itemRow = document.querySelector(`div[data-cart-item-id="${itemId}"]`);
                    if (!itemRow) return;

                    const isActive = itemRow.dataset.isActive === 'true'; // Nên là true vì checkbox không disabled
                    const stock = parseInt(itemRow.dataset.stock);
                    const quantityInput = itemRow.querySelector('.update-quantity-input');
                    const quantity = parseInt(quantityInput.value);
                    const price = parseFloat(itemRow.dataset.price);

                    // Không cần kiểm tra isActive và stock ở đây nữa vì checkbox đã được lọc
                    // Chỉ cần đảm bảo quantity > 0
                    if (quantity > 0) {
                        selectedItemsCount++;
                        subtotal += price * quantity;
                    } else if (quantity <= 0) {
                        // Nếu vì lý do nào đó item được chọn mà quantity là 0, không cho checkout
                        canProceedToCheckout = false;
                        itemRow.classList.add('border-red-300', 'ring-1', 'ring-red-300');
                    }
                    // Kiểm tra lại tồn kho một lần nữa cho chắc chắn
                    if (quantity > stock && stock > 0) { // Nếu SL > tồn kho (và tồn kho > 0)
                        canProceedToCheckout = false;
                        itemRow.classList.add('border-yellow-400', 'ring-1', 'ring-yellow-400'); // Highlight khác
                    } else if (stock === 0 && quantity > 0) { // Nếu hết hàng mà vẫn có số lượng > 0
                        canProceedToCheckout = false;
                        itemRow.classList.add('border-red-300', 'ring-1', 'ring-red-300');
                    }
                    else if (stock > 0 && quantity > 0 && quantity <= stock) {
                        itemRow.classList.remove('border-red-300', 'ring-1', 'ring-red-300', 'border-yellow-400', 'ring-yellow-400');
                    }
                });

                selectedItemsCountEl.textContent = selectedItemsCount;
                subtotalPriceEl.textContent = formatCurrency(subtotal);

                let finalTotal = subtotal;
                if (appliedDiscountDetails && subtotal > 0) {
                    const discountValue = subtotal * (appliedDiscountDetails.percent / 100);
                    discountAmountEl.textContent = `-${formatCurrency(discountValue)}`;
                    discountAppliedTextEl.textContent = `Giảm giá (${appliedDiscountDetails.code} - ${appliedDiscountDetails.percent}%):`;
                    finalTotal -= discountValue;
                } else {
                    discountAmountEl.textContent = '-0đ';
                    discountAppliedTextEl.textContent = `Giảm giá:`;
                }
                selectedCartPriceEl.textContent = formatCurrency(finalTotal < 0 ? 0 : finalTotal);

                checkoutSelectedButton.disabled = selectedItemsCount === 0 || !canProceedToCheckout;
                if (!canProceedToCheckout && selectedItemsCount > 0) {
                    checkoutSelectedButton.title = "Có sản phẩm hết hàng hoặc số lượng không hợp lệ trong các mục đã chọn.";
                } else {
                    checkoutSelectedButton.title = "";
                }
                checkoutButtonSelectedCount.textContent = selectedItemsCount;
                clearSelectedItemsBtn.disabled = selectedItemsCount === 0;

                // Cập nhật trạng thái của selectAllCheckbox
                if (allVisibleAndEnabledCheckboxes.length > 0) {
                    selectAllCheckbox.checked = selectedAndEnabledCheckboxes.length === allVisibleAndEnabledCheckboxes.length;
                    selectAllCheckbox.indeterminate = selectedAndEnabledCheckboxes.length > 0 && selectedAndEnabledCheckboxes.length < allVisibleAndEnabledCheckboxes.length;
                } else {
                    // Nếu không có item nào có thể chọn, selectAll cũng nên là unchecked và disabled
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.disabled = true; // Đã có logic này trong renderCart
                }
            }

            async function fetchCart() {
                cartLoadingEl.classList.remove('hidden');
                cartContentEl.classList.add('hidden');
                const token = getSession('token');
                if (!token) { window.location.href = 'login.html'; return; }
                try {
                    const response = await fetch(`${API_BASE_URL}/Cart`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (response.ok) renderCart(await response.json());
                    else if (response.status === 401) { sessionStorage.removeItem('token'); window.location.href = 'login.html'; }
                    else renderCart({ cartItems: [], totalItems: 0, totalPrice: 0 }); // Xử lý lỗi khác như giỏ hàng trống
                    const mainContentElement = document.getElementById('mainContent');
                    if (mainContentElement) {
                        mainContentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } catch (error) {
                    console.error("Lỗi tải giỏ hàng:", error);
                    cartItemsContainerEl.innerHTML = `<p class="text-red-500 text-center col-span-full py-4">Lỗi tải giỏ hàng.</p>`;
                    renderCart({ cartItems: [], totalItems: 0, totalPrice: 0 });
                }
            }

            async function updateCartItemQuantity(cartItemId, newQuantity) {
                // ... (như trước, sau khi response.ok, gọi fetchCart() để đảm bảo UI đồng bộ hoàn toàn)
                const token = getSession('token');
                if (!token) return;
                if (newQuantity < 1) { await removeCartItem(cartItemId); return; }

                try {
                    const response = await fetch(`${API_BASE_URL}/Cart/items/${cartItemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ quantity: newQuantity })
                    });
                    if (response.ok) {
                        // Thay vì chỉ renderCart, fetch lại toàn bộ để đảm bảo tính nhất quán cao nhất
                        await fetchCart();
                        // Sau khi fetchCart, updateSelectedSummary sẽ được gọi bên trong renderCart
                    } else {
                        const errorData = await response.json().catch(() => ({ message: "Lỗi không xác định." }));
                        alert(`Lỗi cập nhật số lượng: ${errorData.message || response.statusText}`);
                        await fetchCart(); // Tải lại nếu lỗi để đồng bộ
                    }
                } catch (error) { /* ... */ await fetchCart(); }
            }

            async function removeCartItem(cartItemId, silent = false) {
                // ... (như trước, sau khi response.ok, gọi fetchCart())
                const token = getSession('token');
                if (!token) return;

                if (!silent && !confirm("Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?")) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/Cart/items/${cartItemId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        if (!silent) alert("Đã xóa sản phẩm khỏi giỏ hàng.");
                        await fetchCart();
                    } else { /* ... */ await fetchCart(); }
                } catch (error) { /* ... */ await fetchCart(); }
            }

            // --- LOGIC CHO DISCOUNT MODAL ---
            async function loadDiscountsForModal() {
                discountModalLoading.style.display = 'block';
                discountModalList.innerHTML = '';
                noDiscountsMessageModal.classList.add('hidden');
                discountModalListContainer.classList.add('hidden');
                applySelectedDiscountBtn.disabled = true;
                selectedDiscountInModal = null;

                try {
                    const response = await fetch(`${API_BASE_URL}/Discounts/all`, {
                        headers: { 'Authorization': `Bearer ${getSession('token')}` }
                    });
                    if (!response.ok) throw new Error("Không thể tải danh sách mã giảm giá.");

                    const discounts = await response.json();

                    if (discounts && discounts.length > 0) {
                        let validDiscountsExist = false;
                        discounts.forEach(discount => {
                            const now = new Date();
                            const startDate = new Date(discount.startDate);
                            const endDate = new Date(discount.endDate);
                            endDate.setHours(23, 59, 59, 999);

                            if (discount.isActive && now >= startDate && now <= endDate) {
                                validDiscountsExist = true;
                                const discountDiv = document.createElement('div');
                                discountDiv.className = 'discount-item-modal';
                                discountDiv.dataset.code = discount.discountCode;
                                discountDiv.dataset.percent = discount.discountPercent;

                                discountDiv.innerHTML = `
                                    <div>
                                        <span class="discount-code">${discount.discountCode}</span>
                                        <p class="discount-expiry">HSD: ${formatDate(endDate)}</p>
                                    </div>
                                    <span class="discount-percent">Giảm ${discount.discountPercent}%</span>
                                `;
                                discountDiv.addEventListener('click', () => {
                                    discountModalList.querySelectorAll('.selected-discount').forEach(el => el.classList.remove('selected-discount'));
                                    discountDiv.classList.add('selected-discount');
                                    selectedDiscountInModal = { code: discount.discountCode, percent: discount.discountPercent };
                                    applySelectedDiscountBtn.disabled = false;
                                });
                                discountModalList.appendChild(discountDiv);
                            }
                        });
                        if (validDiscountsExist) {
                            discountModalListContainer.classList.remove('hidden');
                        } else {
                            noDiscountsMessageModal.classList.remove('hidden');
                        }
                    } else {
                        noDiscountsMessageModal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Lỗi tải mã giảm giá cho modal:", error);
                    discountModalList.innerHTML = `<p class="text-red-500 text-sm p-3">Lỗi: ${error.message}</p>`;
                    discountModalListContainer.classList.remove('hidden'); // Vẫn hiện container để thấy lỗi
                } finally {
                    discountModalLoading.style.display = 'none';
                }
            }

            if (openDiscountModalBtn) {
                openDiscountModalBtn.addEventListener('click', () => {
                    discountModal.classList.add('active');
                    loadDiscountsForModal();
                });
            }
            if (closeDiscountModalBtn) {
                closeDiscountModalBtn.addEventListener('click', () => {
                    discountModal.classList.remove('active');
                });
            }
            // Đóng modal khi click ra ngoài
            if (discountModal) {
                discountModal.addEventListener('click', (event) => {
                    if (event.target === discountModal) { // Chỉ đóng khi click vào overlay, không phải content
                        discountModal.classList.remove('active');
                    }
                });
            }
            if (applySelectedDiscountBtn) {
                applySelectedDiscountBtn.addEventListener('click', () => {
                    if (selectedDiscountInModal) {
                        discountCodeInput.value = selectedDiscountInModal.code;
                        appliedDiscountDetails = { // Lưu lại thông tin chi tiết để tính toán
                            code: selectedDiscountInModal.code,
                            percent: selectedDiscountInModal.percent
                        };
                        discountMessageEl.textContent = `Đã chọn mã: ${selectedDiscountInModal.code} (-${selectedDiscountInModal.percent}%).`;
                        discountMessageEl.className = 'text-xs mt-1 text-green-600';
                        updateSelectedSummary(); // Cập nhật lại tổng tiền
                        discountModal.classList.remove('active'); // Đóng modal
                    } else {
                        alert("Vui lòng chọn một mã giảm giá.");
                    }
                });
            }

            // Event listener cho nút Thanh toán
            if (checkoutSelectedButton) {
                checkoutSelectedButton.addEventListener('click', async () => {
                    const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked:not([disabled])');

                    if (selectedCheckboxes.length === 0) {
                        alert("Vui lòng chọn ít nhất một sản phẩm để thanh toán.");
                        return;
                    }

                    let proceedWithCheckout = true;
                    const problematicItemsMessages = [];
                    const selectedCartItemIdsForOrder = [];

                    selectedCheckboxes.forEach(checkbox => {
                        const itemId = checkbox.dataset.itemId;
                        const itemRow = document.querySelector(`div[data-cart-item-id="${itemId}"]`);
                        if (itemRow) {
                            const isActive = itemRow.dataset.isActive === 'true';
                            const stock = parseInt(itemRow.dataset.stock);
                            const quantityInput = itemRow.querySelector('.update-quantity-input');
                            const quantity = parseInt(quantityInput.value);
                            const productName = itemRow.querySelector('.text-md.font-semibold')?.textContent || `Sản phẩm ID ${itemRow.dataset.productId}`;

                            if (!isActive) {
                                problematicItemsMessages.push(`- "${productName}": không còn kinh doanh.`);
                                proceedWithCheckout = false;
                            } else if (stock === 0 && quantity > 0) {
                                problematicItemsMessages.push(`- "${productName}": đã hết hàng.`);
                                proceedWithCheckout = false;
                            } else if (quantity > stock) {
                                problematicItemsMessages.push(`- "${productName}": số lượng (${quantity}) vượt quá tồn kho (${stock}).`);
                                proceedWithCheckout = false;
                            } else if (quantity <= 0 && isActive) { // Nếu active mà SL là 0 thì không nên được chọn
                                problematicItemsMessages.push(`- "${productName}": số lượng phải lớn hơn 0.`);
                                proceedWithCheckout = false;
                            }
                            else if (quantity > 0 && isActive && stock > 0) {
                                selectedCartItemIdsForOrder.push(parseInt(itemId));
                            }
                        } else {
                            problematicItemsMessages.push(`- Lỗi: Không tìm thấy thông tin cho một sản phẩm đã chọn.`);
                            proceedWithCheckout = false;
                        }
                    });

                    if (!proceedWithCheckout) {
                        alert("Không thể tiến hành thanh toán.\nVui lòng kiểm tra lại các sản phẩm sau:\n" +
                            problematicItemsMessages.join("\n") +
                            "\n\nBạn có thể cần bỏ chọn, xóa hoặc cập nhật số lượng của chúng.");
                        return;
                    }

                    if (selectedCartItemIdsForOrder.length === 0) {
                        alert("Không có sản phẩm hợp lệ nào được chọn để thanh toán.");
                        return;
                    }

                    let isValidAddress = true;
                    shippingAddressError.classList.add('hidden');
                    const shippingAddress = shippingAddressInput.value.trim();
                    if (!shippingAddress) {
                        shippingAddressError.textContent = "Vui lòng nhập địa chỉ giao hàng.";
                        shippingAddressError.classList.remove('hidden');
                        shippingAddressInput.focus();
                        isValidAddress = false;
                    }
                    if (!isValidAddress) return;

                    const orderPayload = {
                        shippingAddress: shippingAddress,
                        discountCode: appliedDiscountDetails ? appliedDiscountDetails.code : null,
                        selectedCartItemIds: selectedCartItemIdsForOrder
                    };

                    const token = getSession('token');
                    if (!token) { window.location.href = '/Customer/templates/login.html'; return; }

                    checkoutSelectedButton.disabled = true;
                    checkoutSelectedButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';

                    try {
                        const response = await fetch(`${API_BASE_URL}/Orders`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(orderPayload)
                        });
                        if (response.ok) {
                            const createdOrdersData = await response.json();
                            let successMessage = "Đặt hàng thành công!";
                            if (createdOrdersData && Array.isArray(createdOrdersData) && createdOrdersData.length > 0) {
                                if (createdOrdersData.length === 1) {
                                    successMessage = `Đặt hàng thành công! Mã đơn hàng của bạn là #${createdOrdersData[0].orderID}.`;
                                } else {
                                    successMessage = `Đặt hàng thành công! ${createdOrdersData.length} đơn hàng đã được tạo.`;
                                }
                            } else if (createdOrdersData && createdOrdersData.orderID) {
                                successMessage = `Đặt hàng thành công! Mã đơn hàng của bạn là #${createdOrdersData.orderID}.`;
                            }
                            alert(successMessage);
                            appliedDiscountDetails = null;
                            discountCodeInput.value = '';
                            discountMessageEl.textContent = '';
                            fetchCart();
                            document.dispatchEvent(new CustomEvent('cartUpdated'));
                        } else {
                            let errorMessage = "Lỗi đặt hàng không xác định.";
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.message || `Lỗi ${response.status}: ${response.statusText}`;
                            } catch (e) {
                                errorMessage = `Lỗi ${response.status}: ${response.statusText || "Không thể xử lý yêu cầu."}`;
                            }
                            alert(`Lỗi đặt hàng: ${errorMessage}`);
                        }
                    } catch (error) {
                        console.error("Lỗi mạng hoặc lỗi khác khi tạo đơn hàng:", error);
                        alert("Đã xảy ra lỗi kết nối khi tạo đơn hàng. Vui lòng thử lại.");
                    } finally {
                        // updateSelectedSummary sẽ cập nhật lại trạng thái nút
                        const currentSelectedCount = document.querySelectorAll('.cart-item-checkbox:checked:not([disabled])').length;
                        checkoutSelectedButton.disabled = currentSelectedCount === 0; // Disable nếu không còn gì để chọn
                        checkoutSelectedButton.innerHTML = `Thanh toán (<span id="checkoutButtonSelectedCount">${currentSelectedCount}</span>)`;
                        if (typeof updateSelectedSummary === 'function') {
                            updateSelectedSummary();
                        }
                    }
                });
            }

            // Initial Load
            fetchCart();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCustomerCartPage);
        } else {
            setTimeout(initializeCustomerCartPage, 150);
        }
    </script>
</body>

</html>