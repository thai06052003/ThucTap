<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - ShopX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css"> <!-- Link CSS chung -->
    <style>
        .quantity-input {
            width: 4rem;
            /* Điều chỉnh độ rộng của input số lượng */
            text-align: center;
            border: 1px solid #e5e7eb;
            /* gray-300 */
        }

        .quantity-btn {
            border: 1px solid #e5e7eb;
            /* gray-300 */
            background-color: #f9fafb;
            /* gray-50 */
            padding: 0.5rem 0.75rem;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background-color: #f3f4f6;
            /* gray-100 */
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.375rem;
            /* rounded-md */
        }

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            /* Light grey */
            border-top: 4px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Header Container -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <section class="bg-white p-6 md:p-8 rounded-lg shadow-md">
            <!-- Breadcrumbs -->
            <nav class="text-sm mb-6" aria-label="Breadcrumb">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a href="index.html" class="text-gray-500 hover:text-blue-600">Trang chủ</a>
                        <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
                    </li>
                    <li class="flex items-center">
                        <span class="text-gray-700 font-medium">Giỏ hàng</span>
                    </li>
                </ol>
            </nav>

            <h1 class="text-3xl font-bold text-gray-800 mb-6">Giỏ hàng của bạn</h1>

            <div id="cartLoading" class="text-center py-10">
                <div class="loader"></div>
                <p class="text-gray-600 mt-2">Đang tải giỏ hàng...</p>
            </div>

            <div id="cartContent" class="hidden">
                <!-- Cart Items List -->
                <div id="cartItemsContainer" class="divide-y divide-gray-200">
                    <!-- Cart items will be rendered here by JavaScript -->
                </div>

                <!-- Empty Cart Message -->
                <div id="emptyCartMessage" class="text-center py-10 hidden">
                    <i class="fas fa-shopping-cart fa-3x text-gray-400 mb-4"></i>
                    <p class="text-xl text-gray-700 mb-2">Giỏ hàng của bạn đang trống.</p>
                    <a href="index.html" class="text-blue-600 hover:text-blue-700 font-semibold">
                        Tiếp tục mua sắm <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>

                <!-- Cart Summary (chỉ hiển thị nếu giỏ hàng không trống) -->
                <div id="cartSummary" class="mt-8 pt-6 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">Tổng số sản phẩm:</span>
                        <span id="totalItemsCount" class="font-semibold text-gray-800">0</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xl font-semibold text-gray-800">Tổng cộng:</span>
                        <span id="totalCartPrice" class="text-2xl font-bold text-red-600">0đ</span>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end gap-3 mt-6">
                        <a href="index.html"
                            class="w-full sm:w-auto px-6 py-3 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-50 transition">
                            Tiếp tục mua sắm
                        </a>
                        <button id="checkoutButton"
                            class="w-full sm:w-auto px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition flex items-center justify-center">
                            Tiến hành thanh toán <i class="fas fa-credit-card ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <script type="module" src="../assets/js/components.js"></script>
    <script src="../assets/js/index.js" defer></script>
    <script>
        // API_BASE_URL được nạp từ index.js

        document.addEventListener('DOMContentLoaded', async () => {
            const cartLoadingEl = document.getElementById('cartLoading');
            const cartContentEl = document.getElementById('cartContent');
            const cartItemsContainerEl = document.getElementById('cartItemsContainer');
            const emptyCartMessageEl = document.getElementById('emptyCartMessage');
            const cartSummaryEl = document.getElementById('cartSummary');
            const totalItemsCountEl = document.getElementById('totalItemsCount');
            const totalCartPriceEl = document.getElementById('totalCartPrice');
            const checkoutButton = document.getElementById('checkoutButton');

            function formatCurrency(amount) {
                if (typeof amount !== 'number') return '0đ';
                return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            }

            function getCartItemImageUrl(imageURL) {
                // Giả sử hàm getImageUrl đã được định nghĩa trong index.js và có thể truy cập toàn cục
                // Hoặc bạn có thể copy định nghĩa hàm đó vào đây.
                const placeholderImage = '../assets/images/placeholder.png';
                if (!imageURL || imageURL.toLowerCase() === 'string' || imageURL.trim() === '') {
                    return placeholderImage;
                }
                if (/^(https?:)?\/\//i.test(imageURL)) {
                    return imageURL;
                }
                return placeholderImage;
            }

            function renderCartItem(item) {
                const itemSubtotal = item.price * item.quantity;
                return `
                    <div class="py-4 flex flex-col md:flex-row md:items-center gap-4" data-cart-item-id="${item.cartItemID}" data-product-id="${item.productID}">
                        <img src="${getCartItemImageUrl(item.imageURL)}" alt="${item.productName}" class="cart-item-image self-center md:self-start">
                        <div class="flex-grow">
                            <a href="product-detail.html?productId=${item.productID}" class="text-lg font-semibold text-gray-800 hover:text-blue-600">${item.productName}</a>
                            <p class="text-sm text-gray-500">Còn lại: ${item.availableStock}</p>
                            <p class="text-md font-medium text-red-500 mt-1">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center gap-2 self-center md:self-auto">
                            <button class="quantity-btn decrease-quantity" data-item-id="${item.cartItemID}" aria-label="Giảm số lượng">-</button>
                            <input type="number" value="${item.quantity}" min="1" max="${item.availableStock}"
                                   class="quantity-input focus:outline-none focus:ring-1 focus:ring-blue-500 update-quantity-input"
                                   data-item-id="${item.cartItemID}">
                            <button class="quantity-btn increase-quantity" data-item-id="${item.cartItemID}" aria-label="Tăng số lượng">+</button>
                        </div>
                        <div class="text-md font-semibold text-gray-700 w-full md:w-auto text-center md:text-right md:min-w-[120px]">
                            ${formatCurrency(itemSubtotal)}
                        </div>
                        <div class="text-center md:text-right">
                            <button class="text-red-500 hover:text-red-700 remove-item" data-item-id="${item.cartItemID}" aria-label="Xóa sản phẩm">
                                <i class="fas fa-trash-alt"></i> Xóa
                            </button>
                        </div>
                    </div>
                `;
            }

            function renderCart(cartData) {
                cartItemsContainerEl.innerHTML = ''; // Xóa item cũ

                if (cartData && cartData.cartItems && cartData.cartItems.length > 0) {
                    cartData.cartItems.forEach(item => {
                        cartItemsContainerEl.innerHTML += renderCartItem(item);
                    });
                    totalItemsCountEl.textContent = cartData.totalItems;
                    totalCartPriceEl.textContent = formatCurrency(cartData.totalPrice);

                    emptyCartMessageEl.classList.add('hidden');
                    cartSummaryEl.classList.remove('hidden');
                    if (checkoutButton) checkoutButton.disabled = false;
                } else {
                    totalItemsCountEl.textContent = '0';
                    totalCartPriceEl.textContent = formatCurrency(0);
                    emptyCartMessageEl.classList.remove('hidden');
                    cartSummaryEl.classList.add('hidden');
                    if (checkoutButton) checkoutButton.disabled = true;
                }
                cartLoadingEl.classList.add('hidden');
                cartContentEl.classList.remove('hidden');
                attachCartItemEventListeners();
            }

            async function fetchCart() {
                cartLoadingEl.classList.remove('hidden');
                cartContentEl.classList.add('hidden');
                emptyCartMessageEl.classList.add('hidden');
                cartSummaryEl.classList.add('hidden');

                const token = sessionStorage.getItem('token');
                if (!token) {
                    alert("Bạn cần đăng nhập để xem giỏ hàng.");
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/Cart`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        const cartData = await response.json();
                        renderCart(cartData);
                    } else if (response.status === 401) {
                        alert("Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.");
                        sessionStorage.removeItem('token');
                        window.location.href = 'login.html';
                    } else if (response.status === 404) { // API trả về CartDto rỗng nếu không tìm thấy cart, không phải 404.
                        // Xử lý nếu API có thể trả về 404 cho "không có giỏ hàng"
                        renderCart({ cartItems: [], totalItems: 0, totalPrice: 0 });
                    }
                    else {
                        throw new Error(`Lỗi ${response.status}: Không thể tải giỏ hàng.`);
                    }
                } catch (error) {
                    console.error("Lỗi khi tải giỏ hàng:", error);
                    cartItemsContainerEl.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
                    cartLoadingEl.classList.add('hidden');
                    cartContentEl.classList.remove('hidden'); // Vẫn hiển thị content để thấy lỗi
                }
            }

            async function updateCartItemQuantity(cartItemId, newQuantity) {
                const token = sessionStorage.getItem('token');
                if (!token) { /* Xử lý đã có ở fetchCart */ return; }

                if (newQuantity < 1) { // Nếu số lượng là 0 hoặc âm, coi như xóa
                    await removeCartItem(cartItemId);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/Cart/items/${cartItemId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ quantity: newQuantity })
                    });
                    if (response.ok) {
                        const updatedCart = await response.json();
                        renderCart(updatedCart); // Tải lại toàn bộ giỏ hàng để cập nhật tổng tiền
                        // Hoặc có thể cập nhật cục bộ item và tổng tiền nếu muốn tối ưu
                    } else {
                        const errorData = await response.json().catch(() => ({ message: "Lỗi không xác định." }));
                        alert(`Lỗi cập nhật số lượng: ${errorData.message || response.statusText}`);
                        await fetchCart(); // Tải lại giỏ hàng về trạng thái cũ nếu lỗi
                    }
                } catch (error) {
                    console.error("Lỗi khi cập nhật số lượng:", error);
                    alert("Lỗi kết nối khi cập nhật số lượng.");
                    await fetchCart();
                }
            }

            async function removeCartItem(cartItemId) {
                const token = sessionStorage.getItem('token');
                if (!token) { /* Xử lý đã có ở fetchCart */ return; }

                if (!confirm("Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?")) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/Cart/items/${cartItemId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        const updatedCart = await response.json();
                        renderCart(updatedCart);
                        alert("Đã xóa sản phẩm khỏi giỏ hàng.");
                    } else {
                        const errorData = await response.json().catch(() => ({ message: "Lỗi không xác định." }));
                        alert(`Lỗi xóa sản phẩm: ${errorData.message || response.statusText}`);
                        await fetchCart();
                    }
                } catch (error) {
                    console.error("Lỗi khi xóa sản phẩm:", error);
                    alert("Lỗi kết nối khi xóa sản phẩm.");
                    await fetchCart();
                }
            }


            function attachCartItemEventListeners() {
                document.querySelectorAll('.decrease-quantity').forEach(button => {
                    button.addEventListener('click', function () {
                        const itemId = this.dataset.itemId;
                        const input = document.querySelector(`.update-quantity-input[data-item-id="${itemId}"]`);
                        let currentValue = parseInt(input.value);
                        if (currentValue > 1) {
                            updateCartItemQuantity(itemId, currentValue - 1);
                        } else { // Nếu là 1, giảm nữa thì xóa
                            removeCartItem(itemId);
                        }
                    });
                });

                document.querySelectorAll('.increase-quantity').forEach(button => {
                    button.addEventListener('click', function () {
                        const itemId = this.dataset.itemId;
                        const input = document.querySelector(`.update-quantity-input[data-item-id="${itemId}"]`);
                        let currentValue = parseInt(input.value);
                        const maxStock = parseInt(input.max);
                        if (currentValue < maxStock) {
                            updateCartItemQuantity(itemId, currentValue + 1);
                        } else {
                            alert(`Số lượng không thể vượt quá ${maxStock} (tồn kho).`);
                        }
                    });
                });

                document.querySelectorAll('.update-quantity-input').forEach(input => {
                    // Dùng 'change' thay vì 'blur' hoặc 'input' để tránh gọi API quá nhiều lần
                    input.addEventListener('change', function () {
                        const itemId = this.dataset.itemId;
                        let newQuantity = parseInt(this.value);
                        const minQuantity = parseInt(this.min);
                        const maxStock = parseInt(this.max);

                        if (isNaN(newQuantity) || newQuantity < minQuantity) {
                            this.value = minQuantity; // Reset về min nếu nhập không hợp lệ
                            newQuantity = minQuantity;
                        }
                        if (newQuantity > maxStock) {
                            this.value = maxStock;
                            newQuantity = maxStock;
                            alert(`Số lượng không thể vượt quá ${maxStock} (tồn kho).`);
                        }
                        updateCartItemQuantity(itemId, newQuantity);
                    });
                });

                document.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', function () {
                        const itemId = this.dataset.itemId;
                        removeCartItem(itemId);
                    });
                });
            }

            if (checkoutButton) {
                checkoutButton.addEventListener('click', () => {
                    // Điều hướng đến trang thanh toán (ví dụ: checkout.html)
                    // Bạn có thể truyền cartId hoặc dữ liệu giỏ hàng nếu cần
                    alert("Chức năng thanh toán đang được phát triển!");
                    // window.location.href = 'checkout.html';
                });
            }

            // Khởi tạo: Tải giỏ hàng
            fetchCart();
        });
    </script>
</body>

</html>