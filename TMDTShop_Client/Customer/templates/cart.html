<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - ShopX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" type="image/png" href="/Customer/assets/images/logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        /* --- Quantity Controls --- */
        .quantity-input {
            width: 3.5rem;
            text-align: center;
            border-top: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
            border-left: none;
            border-right: none;
            padding-left: 0.25rem;
            padding-right: 0.25rem;
            appearance: textfield;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            color: #374151;
            transition: background-color 0.15s ease-in-out;
        }

        .quantity-btn:hover:not(:disabled) {
            background-color: #e5e7eb;
        }

        .quantity-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Cart Item --- */
        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }

        .product-item-container.unavailable,
        .product-item-container.out-of-stock {
            opacity: 0.65;
            position: relative;
        }

        .item-status-notice {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
            white-space: nowrap;
        }

        .item-status-hidden {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        .item-status-out-of-stock {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        /* --- General Loader --- */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- Custom Checkbox --- */
        .form-checkbox {
            appearance: none;
            padding: 0;
            print-color-adjust: exact;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            height: 1.25rem;
            width: 1.25rem;
            color: #4f46e5;
            background-color: #fff;
            border-color: #6b7280;
            border-width: 1px;
            border-radius: 0.25rem;
        }

        .form-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            border-color: transparent;
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }

        .form-checkbox:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-offset-width: 2px;
            --tw-ring-color: rgba(79, 70, 229, 0.5);
            box-shadow: 0 0 0 var(--tw-ring-offset-width) #fff, 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
        }

        .form-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #d1d5db;
            background-color: #f3f4f6;
        }

        .form-checkbox:disabled:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='%239ca3af' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-color: #e5e7eb;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 500px;
            /* Tăng độ rộng modal một chút */
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(-20px) scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
        }

        .modal-close-btn:hover {
            color: #1f2937;
        }

        .discount-item-modal {
            border: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .discount-item-modal:hover:not(.selected-discount) {
            background-color: #f9fafb;
            border-color: #818cf8;
            /* indigo-400 */
        }

        .discount-item-modal.selected-discount {
            background-color: #e0e7ff;
            /* indigo-100 */
            border-color: #4f46e5;
            /* indigo-600 */
            box-shadow: 0 0 0 2px #c7d2fe;
            /* ring-indigo-300 */
        }

        .discount-item-modal .discount-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .discount-item-modal .discount-code {
            font-weight: 600;
            color: #3730a3;
            /* indigo-800 */
        }

        .discount-item-modal .discount-percent-main {
            font-size: 0.9rem;
            font-weight: 500;
            color: #16a34a;
            /* green-600 */
        }

        .discount-item-modal .discount-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.25rem 0.75rem;
            font-size: 0.8rem;
            color: #4b5563;
            /* gray-600 */
            margin-top: 0.375rem;
        }

        .discount-item-modal .discount-detail-label {
            font-weight: 500;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <div id="header-container"></div>

    <main id="mainContent" class="container mx-auto px-4 py-8">
        <section class="bg-white p-4 md:p-8 rounded-lg shadow-xl">
            <nav class="text-sm mb-6" aria-label="Breadcrumb">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a href="index.html" class="text-gray-500 hover:text-indigo-600">Trang chủ</a>
                        <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
                    </li>
                    <li class="flex items-center"><span class="text-gray-700 font-medium">Giỏ hàng</span></li>
                </ol>
            </nav>

            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Giỏ hàng của bạn</h1>

            <div id="cartLoading" class="text-center py-10">
                <div class="loader mx-auto"></div>
                <p class="text-gray-600 mt-2">Đang tải giỏ hàng...</p>
            </div>

            <div id="cartContent" class="hidden">
                <div id="emptyCartMessage" class="text-center py-16 hidden">
                    <i class="fas fa-shopping-bag fa-4x text-gray-300 mb-6"></i>
                    <p class="text-xl text-gray-700 mb-3">Giỏ hàng của bạn còn trống</p>
                    <p class="text-gray-500 mb-6">Hãy lựa chọn những sản phẩm tuyệt vời nào!</p>
                    <a href="index.html"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
                        Khám phá sản phẩm
                    </a>
                </div>

                <div id="cartHasItems">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b pb-3">
                        <label class="inline-flex items-center cursor-pointer mb-2 sm:mb-0">
                            <input type="checkbox" id="selectAllCheckbox" class="form-checkbox">
                            <span class="ml-2 text-gray-700 font-medium">Chọn tất cả (<span
                                    id="totalCartItemsCount">0</span> sản
                                phẩm)</span>
                        </label>
                        <button id="clearSelectedItemsBtn"
                            class="text-sm text-red-500 hover:text-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium flex items-center"
                            disabled>
                            <i class="fas fa-trash-alt mr-1"></i> Xóa mục đã chọn
                        </button>
                    </div>

                    <div id="cartItemsContainer" class="divide-y divide-gray-200">
                        <!-- Cart items rendered here -->
                    </div>

                    <div id="cartSummary" class="mt-8 pt-6 border-t border-gray-300">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Thông tin thanh toán</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="shippingAddressInput"
                                    class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ giao hàng
                                    <span class="text-red-500">*</span></label>
                                <input type="text" id="shippingAddressInput"
                                    placeholder="Ví dụ: 123 Đường ABC, Phường XYZ, Quận 1, TP.HCM"
                                    class="p-3 border border-gray-300 rounded-md w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <p id="shippingAddressError" class="text-red-500 text-xs mt-1 hidden"></p>
                            </div>
                            <div>
                                <label for="discountCodeInput" class="block text-sm font-medium text-gray-700 mb-1">Mã
                                    giảm giá</label>
                                <div class="flex items-center">
                                    <input type="text" id="discountCodeInput"
                                        placeholder="Nhập mã hoặc chọn từ danh sách" readonly
                                        class="p-3 border border-gray-300 rounded-l-md w-full shadow-sm bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500">
                                    <button id="openDiscountModalBtn" type="button"
                                        class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-3 rounded-r-md font-medium transition flex-shrink-0">
                                        <i class="fas fa-tags mr-1.5"></i> Chọn mã
                                    </button>
                                </div>
                                <p id="discountMessage" class="text-xs mt-1"></p>
                            </div>
                        </div>

                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2 text-gray-700">
                                <span>Số sản phẩm đã chọn:</span>
                                <span id="selectedItemsCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between items-center mb-1 text-gray-700">
                                <span>Tạm tính:</span>
                                <span id="subtotalPrice" class="font-semibold">0đ</span>
                            </div>
                            <div class="flex justify-between items-center mb-3 text-sm text-green-600">
                                <span id="discountAppliedText">Giảm giá:</span>
                                <span id="discountAmount" class="font-semibold">-0đ</span>
                            </div>
                            <div
                                class="flex justify-between items-center text-xl font-bold text-gray-800 border-t pt-3 mt-3">
                                <span>Tổng cộng:</span>
                                <span id="selectedCartPrice" class="text-red-600">0đ</span>
                            </div>
                        </div>

                        <div class="mt-8 flex flex-col sm:flex-row justify-end gap-3">
                            <a href="index.html"
                                class="w-full sm:w-auto px-6 py-3 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-100 transition duration-150 font-medium">
                                Tiếp tục mua sắm
                            </a>
                            <button id="checkoutSelectedButton"
                                class="w-full sm:w-auto px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-lg"
                                disabled>
                                Thanh toán (<span id="checkoutButtonSelectedCount">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-container"></div>

    <!-- Discount Code Modal -->
    <div id="discountModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeDiscountModalBtn" class="modal-close-btn" aria-label="Đóng modal">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Chọn Mã Giảm Giá</h3>
            <div id="discountModalLoading" class="text-center py-5">
                <div class="loader mx-auto"></div>
            </div>
            <div id="discountModalListContainer" class="hidden">
                <div id="discountModalList" class="space-y-2 max-h-72 overflow-y-auto pr-2">
                    <!-- Discount items populated here -->
                </div>
                <div id="noDiscountsMessageModal" class="hidden text-center text-gray-500 py-5">
                    Hiện không có mã giảm giá nào phù hợp.
                </div>
            </div>
            <button id="applySelectedDiscountBtn"
                class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 px-4 rounded-md transition disabled:opacity-50"
                disabled>
                Áp dụng mã đã chọn
            </button>
        </div>
    </div>

    <script src="../assets/js/index.js"></script>
    <script type="module" src="../assets/js/components.js"></script>
    <script>
        function initializeCustomerCartPage() {
            const cartLoadingEl = document.getElementById('cartLoading');
            const cartContentEl = document.getElementById('cartContent');
            const cartItemsContainerEl = document.getElementById('cartItemsContainer');
            const emptyCartMessageEl = document.getElementById('emptyCartMessage');
            const cartHasItemsEl = document.getElementById('cartHasItems');
            const cartSummaryEl = document.getElementById('cartSummary');
            const totalCartItemsCountEl = document.getElementById('totalCartItemsCount');
            const selectedItemsCountEl = document.getElementById('selectedItemsCount');
            const subtotalPriceEl = document.getElementById('subtotalPrice');
            const discountAppliedTextEl = document.getElementById('discountAppliedText');
            const discountAmountEl = document.getElementById('discountAmount');
            const selectedCartPriceEl = document.getElementById('selectedCartPrice');
            const checkoutSelectedButton = document.getElementById('checkoutSelectedButton');
            const checkoutButtonSelectedCount = document.getElementById('checkoutButtonSelectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const clearSelectedItemsBtn = document.getElementById('clearSelectedItemsBtn');
            const shippingAddressInput = document.getElementById('shippingAddressInput');
            const discountCodeInput = document.getElementById('discountCodeInput');
            const discountMessageEl = document.getElementById('discountMessage');
            const shippingAddressError = document.getElementById('shippingAddressError');
            const discountModal = document.getElementById('discountModal');
            const openDiscountModalBtn = document.getElementById('openDiscountModalBtn');
            const closeDiscountModalBtn = document.getElementById('closeDiscountModalBtn');
            const discountModalLoading = document.getElementById('discountModalLoading');
            const discountModalListContainer = document.getElementById('discountModalListContainer');
            const discountModalList = document.getElementById('discountModalList');
            const noDiscountsMessageModal = document.getElementById('noDiscountsMessageModal');
            const applySelectedDiscountBtn = document.getElementById('applySelectedDiscountBtn');

            let currentCartData = null;
            // Lưu trữ chi tiết hơn về discount đã áp dụng
            let appliedDiscountDetails = null; // Sẽ có dạng { code, percent, maxDiscountPercent, remainingBudget, discountId }
            let selectedDiscountInModal = null; // Lưu trữ đầy đủ thông tin của discount được chọn trong modal


            // ... (Kiểm tra hàm, biến toàn cục)
            if (typeof formatDate !== 'function' || typeof formatCurrency !== 'function' || typeof getSession !== 'function' || typeof API_BASE_URL === 'undefined' || typeof getImageUrl !== 'function') {
                console.error("Một số hàm hoặc biến toàn cục từ index.js chưa sẵn sàng.");
                if (cartLoadingEl) cartLoadingEl.innerHTML = '<p class="text-red-500 text-center">Lỗi tải trang. Vui lòng thử lại.</p>';
                return;
            }


            function renderCartItem(item) {
                // ... (Logic render item giữ nguyên, chỉ cần đảm bảo nó không bị lỗi nếu item.product là null)
                const imageUrl = window.getImageUrl(item.imageURL);
                const priceFormatted = window.formatCurrency(item.price);

                let itemClasses = "py-5 flex flex-col sm:flex-row items-start gap-4 product-item-container";
                let checkboxReplacementHtml = '';
                let quantityControlsDisabled = false;
                let quantityInputValue = item.quantity;
                let maxQuantity = item.availableStock;
                let isActuallyUnavailableForPurchase = false;
                let productNameClasses = "text-md lg:text-lg font-semibold text-gray-800 hover:text-indigo-600 block mb-1 truncate";
                let priceClasses = "text-md font-medium text-red-500 mt-1";
                let lineTotalClasses = "text-md lg:text-lg font-semibold text-gray-700 w-full sm:w-auto text-left sm:text-right sm:min-w-[120px] mt-2 sm:mt-0";


                if (!item.isActive) {
                    itemClasses += " unavailable";
                    checkboxReplacementHtml = `<span class="item-status-notice item-status-hidden" title="Sản phẩm đã bị ẩn">Đã ẩn</span>`;
                    quantityControlsDisabled = true;
                    quantityInputValue = 0;
                    isActuallyUnavailableForPurchase = true;
                    productNameClasses += " line-through text-gray-400 no-event";
                    priceClasses += " line-through text-gray-400";
                    lineTotalClasses += " line-through text-gray-400";
                } else if (item.availableStock === 0) {
                    itemClasses += " out-of-stock";
                    checkboxReplacementHtml = `<span class="item-status-notice item-status-out-of-stock" title="Sản phẩm đã hết hàng">Hết hàng</span>`;
                    quantityControlsDisabled = true;
                    isActuallyUnavailableForPurchase = true;
                } else if (item.quantity > item.availableStock) {
                    quantityInputValue = item.availableStock; // Tự động điều chỉnh số lượng về tồn kho tối đa
                }

                const lineTotalForItem = item.price * quantityInputValue;

                return `
                    <div class="${itemClasses}" 
                         data-cart-item-id="${item.cartItemID}" 
                         data-product-id="${item.productID}" 
                         data-price="${item.price}" 
                         data-stock="${item.availableStock}" 
                         data-is-active="${item.isActive}"
                         data-is-unavailable-for-purchase="${isActuallyUnavailableForPurchase}">
                        <div class="flex items-center w-full sm:w-auto ${!item.isActive ? 'pointer-events-none' : ''}">
                             ${checkboxReplacementHtml ?
                        `<div class="h-5 mr-4 flex-shrink-0 flex items-center justify-center">${checkboxReplacementHtml}</div>`
                        :
                        `<input type="checkbox" class="cart-item-checkbox form-checkbox mr-4 flex-shrink-0" 
                                   data-item-id="${item.cartItemID}">`
                    }
                            <img src="${imageUrl}" alt="${item.productName}" class="cart-item-image">
                        </div>
                        <div class="flex-grow min-w-0">
                            <a href="${item.isActive ? `product-detail.html?productId=${item.productID}` : 'javascript:void(0);'}" 
                               class="${productNameClasses}" 
                               title="${item.productName}">${item.productName}</a>
                            
                            ${item.isActive && item.availableStock > 0 ?
                        `<p class="text-sm text-gray-500">Tồn kho: ${item.availableStock}</p>` :
                        (item.isActive && item.availableStock === 0 && !checkboxReplacementHtml ? `<p class="text-sm text-red-500 font-medium">Hết hàng</p>` : '')
                    }
                            
                            <p class="${priceClasses}">${priceFormatted}</p>
                        </div>

                        <div class="flex items-center ${quantityControlsDisabled || !item.isActive ? 'opacity-50 pointer-events-none' : ''}">
                            <button class="quantity-btn decrease-quantity rounded-l-md"
                                    data-item-id="${item.cartItemID}"
                                    aria-label="Giảm số lượng" ${quantityControlsDisabled || !item.isActive || quantityInputValue <= (item.availableStock === 0 && item.isActive ? 0 : 1) ? 'disabled' : ''}>
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" value="${quantityInputValue}" 
                                   min="${item.isActive && item.availableStock > 0 ? 1 : 0}"
                                   max="${maxQuantity}"
                                class="quantity-input update-quantity-input text-center w-14 border-gray-200 border-t border-b py-2 px-0 
                                        focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 
                                        form-input focus:z-10"
                                data-item-id="${item.cartItemID}"
                                aria-label="Số lượng sản phẩm" ${quantityControlsDisabled || !item.isActive ? 'disabled' : ''}>
                            <button class="quantity-btn increase-quantity rounded-r-md"
                                    data-item-id="${item.cartItemID}"
                                    aria-label="Tăng số lượng" ${quantityControlsDisabled || !item.isActive || (item.isActive && item.availableStock === 0 && quantityInputValue >= item.availableStock) || quantityInputValue >= maxQuantity ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="${lineTotalClasses}">
                            ${item.isActive ? formatCurrency(lineTotalForItem) : formatCurrency(0)}
                        </div>
                        <div class="text-center sm:text-right mt-2 sm:mt-0 self-start sm:self-center">
                            <button class="text-red-500 hover:text-red-700 remove-item" data-item-id="${item.cartItemID}" title="Xóa sản phẩm">
                                <i class="fas fa-trash-alt fa-fw"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            function renderCart(cartData) {
                // ... (phần đầu giữ nguyên)
                currentCartData = cartData;
                cartItemsContainerEl.innerHTML = '';
                // Không reset appliedDiscountDetails ở đây nữa, nó sẽ được quản lý khi người dùng chọn hoặc xóa mã.

                if (cartData && cartData.cartItems && cartData.cartItems.length > 0) {
                    let displayableItemCount = 0;
                    cartData.cartItems.forEach(item => {
                        cartItemsContainerEl.innerHTML += renderCartItem(item);
                        if (item.isActive && item.availableStock > 0) {
                            displayableItemCount++;
                        }
                    });
                    totalCartItemsCountEl.textContent = displayableItemCount;
                    emptyCartMessageEl.classList.add('hidden');
                    cartHasItemsEl.classList.remove('hidden');
                    cartSummaryEl.classList.remove('hidden');
                    selectAllCheckbox.disabled = displayableItemCount === 0;
                } else {
                    totalCartItemsCountEl.textContent = '0';
                    emptyCartMessageEl.classList.remove('hidden');
                    cartHasItemsEl.classList.add('hidden');
                    cartSummaryEl.classList.add('hidden');
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.disabled = true;
                    appliedDiscountDetails = null; // Reset discount nếu giỏ hàng trống
                    discountCodeInput.value = '';
                    discountMessageEl.textContent = '';
                }
                updateSelectedSummary();
                attachEventListeners();
                cartLoadingEl.classList.add('hidden');
                cartContentEl.classList.remove('hidden');
            }

            function handleSelectAllChange() { /* ... (giữ nguyên) ... */
                const isChecked = selectAllCheckbox.checked;
                document.querySelectorAll('.cart-item-checkbox:not([disabled])').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateSelectedSummary();
            }

            function attachEventListeners() { /* ... (giữ nguyên) ... */
                selectAllCheckbox.removeEventListener('change', handleSelectAllChange);
                selectAllCheckbox.addEventListener('change', handleSelectAllChange);

                cartItemsContainerEl.querySelectorAll('.cart-item-checkbox').forEach(checkbox => {
                    checkbox.removeEventListener('change', handleCheckboxChange); // Tránh gắn nhiều lần
                    checkbox.addEventListener('change', handleCheckboxChange);
                });

                cartItemsContainerEl.querySelectorAll('.decrease-quantity, .increase-quantity').forEach(button => {
                    button.removeEventListener('click', handleQuantityChange);
                    button.addEventListener('click', handleQuantityChange);
                });
                cartItemsContainerEl.querySelectorAll('.update-quantity-input').forEach(input => {
                    input.removeEventListener('change', handleQuantityChange);
                    input.addEventListener('change', handleQuantityChange);
                });
                cartItemsContainerEl.querySelectorAll('.remove-item').forEach(button => {
                    button.removeEventListener('click', handleRemoveItem);
                    button.addEventListener('click', handleRemoveItem);
                });
            }

            function handleCheckboxChange() { /* ... (giữ nguyên) ... */ updateSelectedSummary(); }

            function handleQuantityChange(event) { /* ... (giữ nguyên, logic API gọi sau) ... */
                const triggeredElement = event.target.closest('button, input'); // Đảm bảo lấy đúng element
                if (!triggeredElement) return;

                const itemId = triggeredElement.dataset.itemId;
                const cartItemDiv = document.querySelector(`div[data-cart-item-id="${itemId}"]`);
                if (!cartItemDiv || cartItemDiv.dataset.isActive !== 'true') return;


                let quantityInput;
                let actionType;

                if (triggeredElement.classList.contains('decrease-quantity')) {
                    actionType = 'decrease';
                    quantityInput = triggeredElement.nextElementSibling;
                } else if (triggeredElement.classList.contains('increase-quantity')) {
                    actionType = 'increase';
                    quantityInput = triggeredElement.previousElementSibling;
                } else if (triggeredElement.classList.contains('update-quantity-input')) {
                    actionType = 'input';
                    quantityInput = triggeredElement;
                } else {
                    return; // Không phải element mong muốn
                }


                const stock = parseInt(cartItemDiv.dataset.stock);
                let currentInputValue = parseInt(quantityInput.value);
                let newQuantity = currentInputValue;


                if (actionType === 'decrease') newQuantity = Math.max(0, currentInputValue - 1); // Cho phép giảm về 0
                else if (actionType === 'increase') newQuantity = Math.min(stock, currentInputValue + 1);
                else if (actionType === 'input') newQuantity = Math.max(0, Math.min(stock, parseInt(quantityInput.value) || 0));


                quantityInput.value = newQuantity;

                // Cập nhật line total ngay lập tức trên UI
                const price = parseFloat(cartItemDiv.dataset.price);
                const lineTotalEl = cartItemDiv.querySelector('.text-md.lg\\:text-lg.font-semibold.text-gray-700');
                if (lineTotalEl) lineTotalEl.textContent = formatCurrency(price * newQuantity);


                // Logic gọi API
                const currentItemData = currentCartData.cartItems.find(item => item.cartItemID == itemId);
                if (currentItemData && currentItemData.quantity !== newQuantity) {
                    if (newQuantity === 0) {
                        removeCartItem(itemId, true); // Xóa ngầm, không confirm
                    } else {
                        updateCartItemQuantity(itemId, newQuantity);
                    }
                } else if (actionType === 'input' && newQuantity === 0 && currentItemData && currentItemData.quantity !== 0) {
                    removeCartItem(itemId, true);
                }
                // Không cần gọi updateSelectedSummary() ở đây nữa, vì updateCartItemQuantity/removeCartItem sẽ gọi fetchCart() => renderCart() => updateSelectedSummary()
            }

            function handleRemoveItem(event) { /* ... (giữ nguyên) ... */
                const itemId = event.target.closest('.remove-item').dataset.itemId;
                removeCartItem(itemId);
            }

            function updateSelectedSummary() {
                // ... (phần lấy selectedCheckboxes, selectedItemsCount, subtotal giữ nguyên) ...
                const allVisibleAndEnabledCheckboxes = document.querySelectorAll('.cart-item-checkbox:not([disabled])');
                const selectedAndEnabledCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked:not([disabled])');

                let selectedItemsCount = 0;
                let subtotal = 0;
                let canProceedToCheckout = true; // Biến cờ kiểm tra

                selectedAndEnabledCheckboxes.forEach(checkbox => {
                    const itemId = checkbox.dataset.itemId;
                    const itemRow = document.querySelector(`div[data-cart-item-id="${itemId}"]`);
                    if (!itemRow) return;

                    const isActive = itemRow.dataset.isActive === 'true';
                    const stock = parseInt(itemRow.dataset.stock);
                    const quantityInput = itemRow.querySelector('.update-quantity-input');
                    const quantity = parseInt(quantityInput.value);
                    const price = parseFloat(itemRow.dataset.price);

                    if (isActive && stock > 0 && quantity > 0 && quantity <= stock) {
                        selectedItemsCount++;
                        subtotal += price * quantity;
                        itemRow.classList.remove('border-red-300', 'ring-1', 'ring-red-300', 'border-yellow-400', 'ring-yellow-400');
                    } else {
                        canProceedToCheckout = false; // Nếu có bất kỳ item nào được chọn mà không hợp lệ
                        // Highlight item không hợp lệ
                        if (!isActive || (stock === 0 && quantity > 0)) {
                            itemRow.classList.add('border-red-300', 'ring-1', 'ring-red-300');
                        } else if (quantity > stock) {
                            itemRow.classList.add('border-yellow-400', 'ring-1', 'ring-yellow-400');
                        } else if (quantity <= 0 && isActive) {
                            itemRow.classList.add('border-red-300', 'ring-1', 'ring-red-300');
                        }
                    }
                });


                selectedItemsCountEl.textContent = selectedItemsCount;
                subtotalPriceEl.textContent = formatCurrency(subtotal);

                let finalTotal = subtotal;
                let calculatedDiscountAmount = 0;

                if (appliedDiscountDetails && subtotal > 0) {
                    const potentialDiscount = (subtotal * appliedDiscountDetails.percent) / 100;
                    calculatedDiscountAmount = potentialDiscount; // Giữ nguyên giá trị %
                    // Áp dụng MaxDiscountPercent (nếu có và > 0)
                    if (appliedDiscountDetails.maxDiscountPercent && appliedDiscountDetails.maxDiscountPercent > 0) {
                        calculatedDiscountAmount = Math.min(calculatedDiscountAmount, appliedDiscountDetails.maxDiscountPercent);
                    }

                    // Làm tròn số tiền giảm
                    calculatedDiscountAmount = Math.round(calculatedDiscountAmount);


                    // Kiểm tra với RemainingBudget (chỉ để hiển thị, backend sẽ quyết định cuối cùng)
                    // Nếu không muốn hiển thị cảnh báo này, có thể bỏ qua
                    if (appliedDiscountDetails.remainingBudget < calculatedDiscountAmount && appliedDiscountDetails.remainingBudget > 0) {
                        discountMessageEl.textContent = `LƯU Ý: Mã ${appliedDiscountDetails.code} chỉ còn ${formatCurrency(appliedDiscountDetails.remainingBudget)} ngân sách. Số tiền giảm có thể bị điều chỉnh khi thanh toán.`;
                        discountMessageEl.className = 'text-xs mt-1 text-yellow-600 font-medium';
                        // Có thể giới hạn calculatedDiscountAmount ở đây để người dùng thấy trước, nhưng backend vẫn là quyết định cuối
                        // calculatedDiscountAmount = Math.min(calculatedDiscountAmount, appliedDiscountDetails.remainingBudget);
                    } else if (appliedDiscountDetails.remainingBudget <= 0) {
                        // Trường hợp này lẽ ra không xảy ra nếu loadDiscountsForModal lọc đúng
                        discountMessageEl.textContent = `Mã ${appliedDiscountDetails.code} đã hết ngân sách.`;
                        discountMessageEl.className = 'text-xs mt-1 text-red-600 font-medium';
                        calculatedDiscountAmount = 0; // Không giảm nữa
                    } else {
                        discountMessageEl.textContent = `Đang áp dụng: ${appliedDiscountDetails.code} (-${appliedDiscountDetails.percent}%, tối đa ${formatCurrency(appliedDiscountDetails.maxDiscountPercent)}).`;
                        discountMessageEl.className = 'text-xs mt-1 text-green-600';
                    }


                    discountAmountEl.textContent = `-${formatCurrency(calculatedDiscountAmount)}`;
                    finalTotal -= calculatedDiscountAmount;
                } else {
                    discountAmountEl.textContent = '-0đ';
                    discountAppliedTextEl.textContent = `Giảm giá:`;
                    if (!discountCodeInput.value) { // Chỉ xóa message nếu không có code nào đang được nhập/chọn
                        discountMessageEl.textContent = '';
                    }
                }

                selectedCartPriceEl.textContent = formatCurrency(finalTotal < 0 ? 0 : finalTotal);
                checkoutSelectedButton.disabled = selectedItemsCount === 0 || !canProceedToCheckout; // Thêm !canProceedToCheckout
                if (!canProceedToCheckout && selectedItemsCount > 0) {
                    checkoutSelectedButton.title = "Có sản phẩm hết hàng hoặc số lượng không hợp lệ trong các mục đã chọn.";
                } else {
                    checkoutSelectedButton.title = "";
                }
                checkoutButtonSelectedCount.textContent = selectedItemsCount;
                clearSelectedItemsBtn.disabled = selectedItemsCount === 0;

                if (allVisibleAndEnabledCheckboxes.length > 0) {
                    selectAllCheckbox.checked = selectedAndEnabledCheckboxes.length === allVisibleAndEnabledCheckboxes.length;
                    selectAllCheckbox.indeterminate = selectedAndEnabledCheckboxes.length > 0 && selectedAndEnabledCheckboxes.length < allVisibleAndEnabledCheckboxes.length;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.disabled = true;
                }
            }


            async function fetchCart() { /* ... (giữ nguyên, nhưng renderCart sẽ gọi updateSelectedSummary) ... */
                cartLoadingEl.classList.remove('hidden');
                cartContentEl.classList.add('hidden');
                const token = getSession('token');
                if (!token) { window.location.href = '/Customer/templates/login.html'; return; } // Đảm bảo URL đúng
                try {
                    const response = await fetch(`${API_BASE_URL}/Cart`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (response.ok) {
                        renderCart(await response.json());
                    }
                    else if (response.status === 401) { sessionStorage.removeItem('token'); window.location.href = '/Customer/templates/login.html'; }
                    else {
                        // Nếu API trả về lỗi khác 401 mà không phải là giỏ hàng trống thực sự
                        const errorData = await response.json().catch(() => null);
                        console.error("Lỗi tải giỏ hàng từ API:", errorData?.message || response.statusText);
                        renderCart({ cartItems: [], totalItems: 0, totalPrice: 0 }); // Hiển thị giỏ hàng trống
                        alert(`Không thể tải giỏ hàng: ${errorData?.message || "Lỗi không xác định."}`);
                    }
                    const mainContentElement = document.getElementById('mainContent');
                    if (mainContentElement) {
                        mainContentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } catch (error) {
                    console.error("Lỗi mạng hoặc lỗi khác khi tải giỏ hàng:", error);
                    cartItemsContainerEl.innerHTML = `<p class="text-red-500 text-center col-span-full py-4">Lỗi tải giỏ hàng. Vui lòng kiểm tra kết nối và thử lại.</p>`;
                    renderCart({ cartItems: [], totalItems: 0, totalPrice: 0 }); // Hiển thị giỏ hàng trống
                }
            }

            async function updateCartItemQuantity(cartItemId, newQuantity) { /* ... (giữ nguyên) ... */
                const token = getSession('token');
                if (!token) return;

                // Không cho phép cập nhật thành 0 qua hàm này, nếu muốn 0 thì phải gọi remove
                if (newQuantity < 1) {
                    await removeCartItem(cartItemId, true); // Xóa ngầm nếu số lượng là 0
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/Cart/items/${cartItemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ quantity: newQuantity })
                    });
                    if (response.ok) {
                        await fetchCart(); // Tải lại toàn bộ giỏ hàng để đảm bảo đồng bộ
                    } else {
                        const errorData = await response.json().catch(() => ({ message: "Lỗi không xác định khi cập nhật số lượng." }));
                        alert(`Lỗi cập nhật số lượng: ${errorData.message || response.statusText}`);
                        await fetchCart(); // Tải lại để khôi phục trạng thái UI đúng
                    }
                } catch (error) {
                    console.error("Lỗi mạng khi cập nhật số lượng:", error);
                    alert("Lỗi mạng khi cập nhật số lượng. Vui lòng thử lại.");
                    await fetchCart(); // Tải lại
                }
            }

            async function removeCartItem(cartItemId, silent = false) { /* ... (giữ nguyên) ... */
                const token = getSession('token');
                if (!token) return;

                if (!silent) { // Chỉ hỏi confirm nếu không phải là xóa ngầm (ví dụ khi số lượng về 0)
                    const itemToRemove = currentCartData?.cartItems?.find(item => item.cartItemID == cartItemId);
                    const productName = itemToRemove?.productName || "sản phẩm này";
                    if (!confirm(`Bạn có chắc chắn muốn xóa "${productName}" khỏi giỏ hàng?`)) return;
                }


                try {
                    const response = await fetch(`${API_BASE_URL}/Cart/items/${cartItemId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        if (!silent) alert("Đã xóa sản phẩm khỏi giỏ hàng.");
                        await fetchCart();
                        document.dispatchEvent(new CustomEvent('cartUpdated')); // Thông báo cho header cập nhật
                    } else {
                        const errorData = await response.json().catch(() => ({ message: "Lỗi không xác định khi xóa sản phẩm." }));
                        if (!silent) alert(`Lỗi xóa sản phẩm: ${errorData.message || response.statusText}`);
                        await fetchCart(); // Tải lại để đồng bộ
                    }
                } catch (error) {
                    console.error("Lỗi mạng khi xóa sản phẩm:", error);
                    if (!silent) alert("Lỗi mạng khi xóa sản phẩm. Vui lòng thử lại.");
                    await fetchCart();
                }
            }

            clearSelectedItemsBtn.addEventListener('click', async () => {
                const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked:not([disabled])');
                if (selectedCheckboxes.length === 0) return;

                if (!confirm(`Bạn có chắc muốn xóa ${selectedCheckboxes.length} mục đã chọn khỏi giỏ hàng?`)) return;

                const token = getSession('token');
                if (!token) { window.location.href = 'login.html'; return; }

                const itemIdsToDelete = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.itemId));

                // Gọi API xóa hàng loạt (nếu backend hỗ trợ) hoặc lặp qua từng item
                // Giả sử backend có endpoint /Cart/items/batch-delete (Body: { cartItemIds: [...] })
                try {
                    const response = await fetch(`${API_BASE_URL}/Cart/items/batch-delete`, { // Thay bằng endpoint thực tế của bạn
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ cartItemIds: itemIdsToDelete })
                    });

                    if (response.ok) {
                        alert("Đã xóa các mục đã chọn.");
                        fetchCart(); // Tải lại giỏ hàng
                        document.dispatchEvent(new CustomEvent('cartUpdated'));
                    } else {
                        const errorData = await response.json().catch(() => ({ message: "Lỗi không xác định." }));
                        alert(`Lỗi xóa hàng loạt: ${errorData.message || response.statusText}`);
                        fetchCart(); // Tải lại để đồng bộ
                    }
                } catch (error) {
                    console.error("Lỗi mạng khi xóa hàng loạt:", error);
                    alert("Lỗi mạng khi xóa hàng loạt. Vui lòng thử lại.");
                    fetchCart();
                }
            });

            // --- LOGIC CHO DISCOUNT MODAL ---
            async function loadDiscountsForModal() {
                // ... (phần loading, reset giữ nguyên) ...
                discountModalLoading.style.display = 'block';
                discountModalList.innerHTML = '';
                noDiscountsMessageModal.classList.add('hidden');
                discountModalListContainer.classList.add('hidden');
                applySelectedDiscountBtn.disabled = true;
                selectedDiscountInModal = null; // Reset lựa chọn trong modal


                try {
                    const response = await fetch(`${API_BASE_URL}/Discounts/all`, { // Endpoint này nên trả về DiscountDto
                        headers: { 'Authorization': `Bearer ${getSession('token')}` }
                    });
                    if (!response.ok) throw new Error(`Không thể tải danh sách mã giảm giá (${response.status})`);

                    const discounts = await response.json(); // Đây là List<DiscountDto>

                    if (discounts && discounts.length > 0) {
                        let validDiscountsExist = false;
                        discounts.forEach(discount => { // discount ở đây là DiscountDto
                            const now = new Date();
                            // Parse lại ngày tháng từ DTO vì có thể là string
                            const startDate = new Date(discount.startDate);
                            const endDate = new Date(discount.endDate);
                            endDate.setHours(23, 59, 59, 999); // Đảm bảo so sánh đến cuối ngày

                            // **THÊM KIỂM TRA RemainingBudget > 0**
                            if (discount.isActive && now >= startDate && now <= endDate && discount.remainingBudget > 0) {
                                validDiscountsExist = true;
                                const discountDiv = document.createElement('div');
                                discountDiv.className = 'discount-item-modal';
                                // Lưu trữ đầy đủ thông tin cần thiết vào dataset
                                discountDiv.dataset.discountId = discount.discountID;
                                discountDiv.dataset.code = discount.discountCode;
                                discountDiv.dataset.percent = discount.discountPercent;
                                discountDiv.dataset.maxDiscountPercent = discount.maxDiscountPercent; // Số tiền giảm tối đa
                                discountDiv.dataset.remainingBudget = discount.remainingBudget;

                                discountDiv.innerHTML = `
                                    <div>
                                        <div class="discount-header">
                                            <span class="discount-code">${discount.discountCode}</span>
                                            <span class="discount-percent-main">Giảm ${discount.discountPercent}%</span>
                                        </div>
                                        <div class="discount-details-grid">
                                            <div><span class="discount-detail-label">Tối đa:</span> ${formatCurrency(discount.maxDiscountPercent)}</div>
                                            <div><span class="discount-detail-label">Ngân sách còn:</span> ${formatCurrency(discount.remainingBudget)}</div>
                                        </div>
                                        <p class="discount-expiry">HSD: ${formatDate(endDate)}</p>
                                    </div>
                                `;
                                discountDiv.addEventListener('click', () => {
                                    discountModalList.querySelectorAll('.selected-discount').forEach(el => el.classList.remove('selected-discount'));
                                    discountDiv.classList.add('selected-discount');
                                    // Lưu trữ đầy đủ thông tin của discount được chọn
                                    selectedDiscountInModal = {
                                        discountId: discount.discountID,
                                        code: discount.discountCode,
                                        percent: discount.discountPercent,
                                        maxDiscountPercent: discount.maxDiscountPercent,
                                        remainingBudget: discount.remainingBudget
                                    };
                                    applySelectedDiscountBtn.disabled = false;
                                });
                                discountModalList.appendChild(discountDiv);
                            }
                        });
                        if (validDiscountsExist) {
                            discountModalListContainer.classList.remove('hidden');
                        } else {
                            noDiscountsMessageModal.classList.remove('hidden'); // Hiện thông báo không có mã
                        }
                    } else {
                        noDiscountsMessageModal.classList.remove('hidden');
                    }
                } catch (error) { /* ... (xử lý lỗi giữ nguyên) ... */
                    console.error("Lỗi tải mã giảm giá cho modal:", error);
                    discountModalList.innerHTML = `<p class="text-red-500 text-sm p-3">Lỗi: ${error.message}</p>`;
                    discountModalListContainer.classList.remove('hidden');
                } finally {
                    discountModalLoading.style.display = 'none';
                }
            }

            if (openDiscountModalBtn) { /* ... (giữ nguyên) ... */
                openDiscountModalBtn.addEventListener('click', () => {
                    discountModal.classList.add('active');
                    loadDiscountsForModal();
                });
            }
            if (closeDiscountModalBtn) { /* ... (giữ nguyên) ... */
                closeDiscountModalBtn.addEventListener('click', () => {
                    discountModal.classList.remove('active');
                });
            }
            if (discountModal) { /* ... (giữ nguyên) ... */
                discountModal.addEventListener('click', (event) => {
                    if (event.target === discountModal) {
                        discountModal.classList.remove('active');
                    }
                });
            }

            if (applySelectedDiscountBtn) {
                applySelectedDiscountBtn.addEventListener('click', () => {
                    if (selectedDiscountInModal) {
                        discountCodeInput.value = selectedDiscountInModal.code;
                        // Lưu trữ chi tiết hơn
                        appliedDiscountDetails = { ...selectedDiscountInModal }; // Sao chép object

                        discountMessageEl.textContent = `Đã chọn: ${appliedDiscountDetails.code} (-${appliedDiscountDetails.percent}%, tối đa ${formatCurrency(appliedDiscountDetails.maxDiscountPercent)}).`;
                        discountMessageEl.className = 'text-xs mt-1 text-green-600';
                        updateSelectedSummary();
                        discountModal.classList.remove('active');
                    } else {
                        alert("Vui lòng chọn một mã giảm giá.");
                    }
                });
            }

            // Event listener cho nút Thanh toán
            if (checkoutSelectedButton) { /* ... (giữ nguyên, chỉ cần đảm bảo payload gửi đi đúng) ... */
                checkoutSelectedButton.addEventListener('click', async () => {
                    const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked:not([disabled])');

                    if (selectedCheckboxes.length === 0) { /* ... */ return; }

                    let proceedWithCheckout = true;
                    const problematicItemsMessages = [];
                    const selectedCartItemIdsForOrder = [];

                    selectedCheckboxes.forEach(checkbox => {
                        const itemId = checkbox.dataset.itemId;
                        const itemRow = document.querySelector(`div[data-cart-item-id="${itemId}"]`);
                        if (itemRow) {
                            const isActive = itemRow.dataset.isActive === 'true';
                            const stock = parseInt(itemRow.dataset.stock);
                            const quantityInput = itemRow.querySelector('.update-quantity-input');
                            const quantity = parseInt(quantityInput.value);
                            const productName = itemRow.querySelector('.text-md.lg\\:text-lg.font-semibold')?.textContent || `Sản phẩm ID ${itemRow.dataset.productId}`;

                            if (!isActive || (stock === 0 && quantity > 0) || (quantity > stock && stock > 0) || (quantity <= 0 && isActive)) {
                                proceedWithCheckout = false;
                                // Build message cụ thể hơn
                                if (!isActive) problematicItemsMessages.push(`- "${productName}": không còn kinh doanh.`);
                                else if (stock === 0 && quantity > 0) problematicItemsMessages.push(`- "${productName}": đã hết hàng.`);
                                else if (quantity > stock) problematicItemsMessages.push(`- "${productName}": số lượng (${quantity}) vượt quá tồn kho (${stock}).`);
                                else if (quantity <= 0) problematicItemsMessages.push(`- "${productName}": số lượng phải lớn hơn 0.`);
                            } else {
                                selectedCartItemIdsForOrder.push(parseInt(itemId));
                            }
                        } else {
                            problematicItemsMessages.push(`- Lỗi: Không tìm thấy thông tin cho một sản phẩm đã chọn.`);
                            proceedWithCheckout = false;
                        }
                    });

                    if (!proceedWithCheckout) {
                        alert("Không thể tiến hành thanh toán.\nVui lòng kiểm tra lại các sản phẩm sau:\n" +
                            problematicItemsMessages.join("\n") +
                            "\n\nBạn có thể cần bỏ chọn, xóa hoặc cập nhật số lượng của chúng.");
                        return;
                    }


                    if (selectedCartItemIdsForOrder.length === 0) { /* ... */ return; }

                    let isValidAddress = true;
                    shippingAddressError.classList.add('hidden');
                    const shippingAddress = shippingAddressInput.value.trim();
                    if (!shippingAddress) { /* ... */ isValidAddress = false; }
                    if (!isValidAddress) return;

                    const orderPayload = {
                        shippingAddress: shippingAddress,
                        // Gửi discountCode, backend sẽ xử lý logic còn lại
                        discountCode: appliedDiscountDetails ? appliedDiscountDetails.code : null,
                        selectedCartItemIds: selectedCartItemIdsForOrder
                    };

                    const token = getSession('token');
                    if (!token) { /* ... */ return; }

                    checkoutSelectedButton.disabled = true;
                    checkoutSelectedButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';

                    try {
                        const response = await fetch(`${API_BASE_URL}/Orders`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(orderPayload)
                        });
                        if (response.ok) {
                            // ... (xử lý thành công như cũ)
                            const createdOrdersData = await response.json();
                            let successMessage = "Đặt hàng thành công!";
                            if (createdOrdersData && Array.isArray(createdOrdersData) && createdOrdersData.length > 0) {
                                if (createdOrdersData.length === 1) {
                                    successMessage = `Đặt hàng thành công! Mã đơn hàng của bạn là #${createdOrdersData[0].orderID}.`;
                                } else {
                                    const orderIds = createdOrdersData.map(o => `#${o.orderID}`).join(', ');
                                    successMessage = `Đặt hàng thành công! ${createdOrdersData.length} đơn hàng đã được tạo: ${orderIds}.`;
                                }
                            } else if (createdOrdersData && createdOrdersData.orderID) { // Xử lý trường hợp API trả về một OrderDto duy nhất
                                successMessage = `Đặt hàng thành công! Mã đơn hàng của bạn là #${createdOrdersData.orderID}.`;
                            }
                            alert(successMessage);
                            appliedDiscountDetails = null; // Reset sau khi đặt hàng thành công
                            discountCodeInput.value = '';
                            discountMessageEl.textContent = '';
                            fetchCart();
                            document.dispatchEvent(new CustomEvent('cartUpdated'));
                        } else {
                            // ... (xử lý lỗi như cũ)
                            let errorMessage = "Lỗi đặt hàng không xác định.";
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.message || (errorData.errors ? JSON.stringify(errorData.errors) : `Lỗi ${response.status}: ${response.statusText}`);
                            } catch (e) {
                                errorMessage = `Lỗi ${response.status}: ${response.statusText || "Không thể xử lý yêu cầu."}`;
                            }
                            alert(`Lỗi đặt hàng: ${errorMessage}`);
                        }
                    } catch (error) { /* ... */ } finally { /* ... */
                        const currentSelectedCount = document.querySelectorAll('.cart-item-checkbox:checked:not([disabled])').length;
                        checkoutSelectedButton.disabled = currentSelectedCount === 0;
                        checkoutSelectedButton.innerHTML = `Thanh toán (<span id="checkoutButtonSelectedCount">${currentSelectedCount}</span>)`;
                        if (typeof updateSelectedSummary === 'function') {
                            updateSelectedSummary();
                        }
                    }
                });
            }

            // Initial Load
            fetchCart();
            // Load địa chỉ giao hàng từ User (nếu có)
            const currentUser = getSession('currentUser');
            if (currentUser && currentUser.address && shippingAddressInput) {
                shippingAddressInput.value = currentUser.address;
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCustomerCartPage);
        } else {
            // Để đảm bảo các hàm từ index.js đã được load
            // Có thể cần một cơ chế tốt hơn để đảm bảo thứ tự load script nếu index.js load bất đồng bộ
            setTimeout(initializeCustomerCartPage, 200);
        }
    </script>
</body>

</html>