<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liên Hệ - ShopX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="icon" type="image/png" href="/Customer/assets/images/logo.jpg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body class="bg-gray-50 font-sans">
  <!-- Header Container -->
  <div id="header-container"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Contact Hero -->
    <section class="relative bg-gradient-to-r from-blue-600 to-indigo-700 py-20 mb-12 rounded-lg shadow-xl">
      <div class="container mx-auto px-4 text-center text-white">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 animate-fade-in-down">Liên hệ với chúng tôi</h1>
        <p class="text-lg md:text-xl animate-fade-in-up">Mọi thắc mắc và yêu cầu hỗ trợ, vui lòng liên hệ qua thông tin
          bên dưới hoặc gửi tin nhắn cho chúng tôi.</p>
      </div>
    </section>

    <!-- Contact Content -->
    <section class="py-16 bg-white rounded-lg shadow-xl">
      <div class="container mx-auto px-4">
        <div class="flex flex-col lg:flex-row gap-12">
          <!-- Contact Form -->
          <div class="lg:w-2/3 xl:w-1/2">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Gửi tin nhắn cho chúng tôi</h2>
            <form id="contactForm" class="space-y-6">
              <div>
                <label for="contactMessage" class="block text-sm font-medium text-gray-700 mb-2">Nội dung liên hệ <span
                    class="text-red-500">*</span></label>
                <textarea id="contactMessage" name="message" rows="6" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow shadow-sm"
                  placeholder="Nhập nội dung bạn muốn gửi... (tối thiểu 10 ký tự)"></textarea>
                <p id="messageError" class="text-red-500 text-xs mt-1 hidden">Nội dung phải từ 10 đến 2000 ký tự.</p>
              </div>
              <button type="submit" id="submitContactBtn"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-paper-plane mr-2"></i>Gửi tin nhắn
              </button>
              <div id="formFeedback" class="mt-4 text-sm"></div>
            </form>
          </div>

          <!-- Contact Info -->
          <div class="lg:w-1/3 xl:w-1/2 mt-12 lg:mt-0">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Thông tin liên hệ</h2>
            <div class="space-y-6">
              <div class="flex items-start p-4 bg-indigo-50 rounded-lg shadow">
                <div class="bg-indigo-100 p-3 rounded-full mr-4 flex-shrink-0">
                  <i class="fas fa-map-marker-alt text-indigo-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-bold text-lg mb-1">Địa chỉ cửa hàng</h3>
                  <p class="text-gray-600">11 Lý Thường Kiệt, P. Phú Nhuận, TP. Huế</p>
                </div>
              </div>

              <div class="flex items-start p-4 bg-indigo-50 rounded-lg shadow">
                <div class="bg-indigo-100 p-3 rounded-full mr-4 flex-shrink-0">
                  <i class="fas fa-phone-alt text-indigo-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg text-gray-700 mb-1">Điện thoại</h3>
                  <p class="text-gray-600">1900 1234 (Hỗ trợ 24/7)</p>
                </div>
              </div>

              <div class="flex items-start p-4 bg-indigo-50 rounded-lg shadow">
                <div class="bg-indigo-100 p-3 rounded-full mr-4 flex-shrink-0">
                  <i class="fas fa-envelope text-indigo-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg text-gray-700 mb-1">Email</h3>
                  <p class="text-gray-600"><a href="mailto:support@shopx.vn"
                      class="hover:underline">support@shopx.vn</a></p>
                </div>
              </div>
            </div>

            <div class="mt-12">
              <h3 class="font-bold text-lg mb-4">Theo dõi chúng tôi</h3>
              <div class="flex space-x-4">
                <a href="https://www.facebook.com/quocminh20" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition">
                  <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="bg-pink-600 text-white p-3 rounded-full hover:bg-pink-700 transition">
                  <i class="fab fa-instagram"></i>
                </a>
                <a href="#" class="bg-blue-400 text-white p-3 rounded-full hover:bg-blue-500 transition">
                  <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="bg-red-600 text-white p-3 rounded-full hover:bg-red-700 transition">
                  <i class="fab fa-youtube"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer Container -->
  <div id="footer-container"></div>
  

  <!-- Chatbot -->

  <!-- Scripts -->
  <script src="../assets/js/index.js"></script>
  <script type="module" src="../assets/js/components.js"></script>
 
 

<!-- ✅ 1. INTERCOM CONFIGURATION - BASED ON OFFICIAL SCRIPT -->
<script>
  // ✅ Development Environment Detection
  const isDevelopment = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' ||
                       window.location.port === '5500';

  // ✅ Get user info từ ShopX session TRƯỚC KHI CONFIG
  function getUserForIntercom() {
    try {
      if (typeof getSession === 'function') {
        const token = getSession('token');
        const userInfo = getSession('userInfo');
        
        if (token && userInfo) {
          return {
            id: userInfo.userID || userInfo.userId || 'anonymous_' + Date.now(),
            name: userInfo.fullName || 'ShopX Customer',
            email: userInfo.email || null,
            createdAt: Math.floor(Date.now() / 1000), // Unix timestamp
            phone: userInfo.phone || null
          };
        }
      }
    } catch (error) {
      console.warn('Could not get user info for Intercom:', error);
    }
    
    // Fallback for anonymous users
    return {
      id: 'anonymous_' + Date.now(),
      name: 'Khách hàng ShopX',
      email: null,
      createdAt: Math.floor(Date.now() / 1000)
    };
  }

  // ✅ Get user data
  const user = getUserForIntercom();

  // ✅ Intercom Settings - THEO SCRIPT CHÍNH THỨC
  window.intercomSettings = {
    api_base: "https://api-iam.intercom.io", // ✅ GIỐNG SCRIPT GỐC
    app_id: "rk8if99h",
    user_id: user.id, // ✅ THEO SCRIPT GỐC
    name: user.name, // ✅ THEO SCRIPT GỐC  
    email: user.email, // ✅ THEO SCRIPT GỐC
    created_at: user.createdAt, // ✅ THEO SCRIPT GỐC
    
    // ✅ Additional customization
    background_color: "#2563eb",
    action_color: "#2563eb", 
    language_override: "vi",
    
    // ✅ KHÔNG ẨN LAUNCHER - để Intercom tự quyết định
    // hide_default_launcher: false, // ✅ EXPLICIT FALSE
    
    // ✅ Custom attributes
    custom_attributes: {
      'customer_type': 'ShopX_Customer',
      'registration_source': 'Website',
      'website_section': 'Contact Page',
      'shopx_customer_id': user.id,
      'development_mode': isDevelopment
    }
  };

  console.log('✅ Intercom settings configured:', {
    user_id: user.id,
    name: user.name,
    email: user.email,
    development: isDevelopment
  });
</script>

<!-- ✅ 2. INTERCOM INSTALLATION - SCRIPT CHÍNH THỨC TỪ INTERCOM -->
<script>
  // We pre-filled your app ID in the widget URL: 'https://widget.intercom.io/widget/rk8if99h'
  (function(){
    try {
      var w=window;
      var ic=w.Intercom;
      if(typeof ic==="function"){
        ic('reattach_activator');
        ic('update',w.intercomSettings);
      } else {
        var d=document;
        var i=function(){i.c(arguments);};
        i.q=[];
        i.c=function(args){i.q.push(args);};
        w.Intercom=i;
        var l=function(){
          var s=d.createElement('script');
          s.type='text/javascript';
          s.async=true;
          s.src='https://widget.intercom.io/widget/rk8if99h'; // ✅ HARDCODED như script gốc
          
          // ✅ Error handling cho development
          s.onerror = function() {
            if (isDevelopment) {
              console.warn('⚠️ Intercom script failed to load (CORS in development)');
              setTimeout(createFallbackChat, 2000);
            } else {
              console.error('❌ Intercom script failed to load');
            }
          };
          
          s.onload = function() {
            console.log('✅ Intercom script loaded successfully');
          };
          
          var x=d.getElementsByTagName('script')[0];
          x.parentNode.insertBefore(s,x);
        };
        
        if(document.readyState==='complete'){
          l();
        } else if(w.attachEvent){
          w.attachEvent('onload',l);
        } else {
          w.addEventListener('load',l,false);
        }
      }
    } catch (error) {
      console.warn('⚠️ Intercom initialization failed:', error);
      if (isDevelopment) {
        setTimeout(createFallbackChat, 2000);
      }
    }
  })();
</script>

<!-- ✅ 3. INTERCOM INTEGRATION & FALLBACK -->
<script>
  (function() {
      'use strict';
      
      let intercomReady = false;
      
      // ✅ Wait for Intercom to be ready
      function waitForIntercomReady() {
          if (typeof window.Intercom !== 'undefined' && window.Intercom.q) {
              // Intercom is loaded
              setTimeout(initializeIntercomIntegration, 1000);
          } else {
              setTimeout(waitForIntercomReady, 500);
          }
      }
      
      function initializeIntercomIntegration() {
          try {
              console.log('✅ Initializing Intercom integration');
              
              // ✅ Check if launcher appears
              setTimeout(function() {
                  const launcher = document.querySelector('.intercom-launcher');
                  if (launcher && launcher.style.display !== 'none') {
                      console.log('✅ Intercom launcher detected');
                      intercomReady = true;
                      setupIntercomEvents();
                      injectCustomCSS();
                  } else {
                      console.warn('⚠️ Intercom launcher not found, creating fallback');
                      createFallbackChat();
                  }
              }, 3000);
              
          } catch (error) {
              console.warn('⚠️ Intercom integration error:', error);
              createFallbackChat();
          }
      }
      
      function setupIntercomEvents() {
          try {
              window.Intercom('onShow', function() {
                  console.log('💬 Intercom opened');
              });
              
              window.Intercom('onHide', function() {
                  console.log('💬 Intercom closed');
              });
              
              window.Intercom('onUnreadCountChanged', function(unreadCount) {
                  console.log('📨 Unread messages:', unreadCount);
              });
              
          } catch (error) {
              console.warn('Could not setup Intercom event listeners:', error);
          }
      }
      
      function injectCustomCSS() {
          const style = document.createElement('style');
          style.textContent = `
              .intercom-launcher {
                  background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
                  box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.4) !important;
                  transition: all 0.3s ease !important;
              }
              
              .intercom-launcher:hover {
                  transform: scale(1.1) !important;
                  box-shadow: 0 6px 20px 0 rgba(37, 99, 235, 0.6) !important;
              }
              
              .intercom-lightweight-app {
                  border-radius: 12px !important;
                  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1) !important;
              }
          `;
          document.head.appendChild(style);
      }
      
      // ✅ Global fallback chat function
      window.createFallbackChat = function() {
          // Remove existing fallback
          const existing = document.getElementById('shopx-fallback-chat');
          if (existing) existing.remove();
          
          const fallbackHTML = `
              <div id="shopx-fallback-chat" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
                  <div id="fallback-launcher" 
                       style="background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); 
                              width: 60px; height: 60px; border-radius: 50%; 
                              display: flex; align-items: center; justify-content: center; 
                              color: white; cursor: pointer; 
                              box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4);
                              transition: all 0.3s ease;"
                       onclick="toggleFallbackWindow()"
                       onmouseover="this.style.transform='scale(1.1)'"
                       onmouseout="this.style.transform='scale(1)'">
                      <i class="fas fa-comments" style="font-size: 24px;"></i>
                  </div>
                  
                  <div id="fallback-window" 
                       style="position: absolute; bottom: 70px; right: 0; 
                              background: white; width: 350px; height: 450px; 
                              border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
                              display: none; flex-direction: column; overflow: hidden;
                              border: 1px solid #e5e7eb;">
                      <!-- Header -->
                      <div style="background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); 
                                  color: white; padding: 16px; display: flex; justify-content: space-between; 
                                  align-items: center;">
                          <div>
                              <h3 style="margin: 0; font-size: 16px; font-weight: bold;">
                                  <i class="fas fa-headset"></i> ShopX Support
                              </h3>
                              <p style="margin: 0; font-size: 12px; opacity: 0.9;">
                                  Hỗ trợ khách hàng 24/7
                              </p>
                          </div>
                          <button onclick="toggleFallbackWindow()" 
                                  style="background: none; border: none; color: white; 
                                         font-size: 18px; cursor: pointer;">
                              <i class="fas fa-times"></i>
                          </button>
                      </div>
                      
                      <!-- Content -->
                      <div style="flex: 1; padding: 20px; overflow-y: auto;">
                          <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                              <p style="margin: 0; color: #374151; line-height: 1.5;">
                                  👋 Chào bạn! Tôi là ShopX Support.<br><br>
                                  ${isDevelopment ? '🚧 <strong>Development Mode:</strong> Intercom đang gặp vấn đề.<br><br>' : ''}
                                  💡 <strong>Bạn có thể liên hệ qua:</strong>
                              </p>
                          </div>
                          
                          <div onclick="scrollToContactForm()" 
                               style="background: #eff6ff; padding: 12px; border-radius: 8px; 
                                      cursor: pointer; margin-bottom: 8px; border-left: 4px solid #2563eb;">
                              <strong style="color: #2563eb;">📝 Form liên hệ</strong><br>
                              <small style="color: #6b7280;">Gửi tin nhắn trên trang này</small>
                          </div>
                          
                          <div onclick="window.open('tel:19001234')" 
                               style="background: #f0fdf4; padding: 12px; border-radius: 8px; 
                                      cursor: pointer; margin-bottom: 8px; border-left: 4px solid #16a34a;">
                              <strong style="color: #16a34a;">📞 Hotline</strong><br>
                              <small style="color: #6b7280;">1900 1234 (24/7)</small>
                          </div>
                          
                          <div onclick="window.open('mailto:support@shopx.vn')" 
                               style="background: #fef7ff; padding: 12px; border-radius: 8px; 
                                      cursor: pointer; margin-bottom: 8px; border-left: 4px solid #a855f7;">
                              <strong style="color: #a855f7;">📧 Email</strong><br>
                              <small style="color: #6b7280;">support@shopx.vn</small>
                          </div>
                          
                          <div onclick="window.open('https://www.facebook.com/quocminh20')" 
                               style="background: #eff6ff; padding: 12px; border-radius: 8px; 
                                      cursor: pointer; border-left: 4px solid #1877f2;">
                              <strong style="color: #1877f2;">📱 Facebook</strong><br>
                              <small style="color: #6b7280;">Nhắn tin Facebook</small>
                          </div>
                      </div>
                  </div>
              </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', fallbackHTML);
          console.log('🔧 Fallback chat created');
          
          // Global functions
          window.toggleFallbackWindow = function() {
              const window_el = document.getElementById('fallback-window');
              const launcher = document.getElementById('fallback-launcher');
              
              if (window_el.style.display === 'none') {
                  window_el.style.display = 'flex';
                  launcher.innerHTML = '<i class="fas fa-times" style="font-size: 24px;"></i>';
              } else {
                  window_el.style.display = 'none';
                  launcher.innerHTML = '<i class="fas fa-comments" style="font-size: 24px;"></i>';
              }
          };
          
          window.scrollToContactForm = function() {
              document.getElementById('contactForm').scrollIntoView({ 
                  behavior: 'smooth', 
                  block: 'center' 
              });
              setTimeout(() => {
                  document.getElementById('contactMessage').focus();
              }, 500);
              window.toggleFallbackWindow();
          };
      };
      
      // ✅ Keyboard shortcut
      document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.altKey && e.key === 'c') {
              e.preventDefault();
              if (intercomReady && typeof window.Intercom !== 'undefined') {
                  try {
                      window.Intercom('show');
                  } catch (error) {
                      window.toggleFallbackWindow();
                  }
              } else {
                  window.toggleFallbackWindow();
              }
          }
      });
      
      // ✅ Initialize
      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', waitForIntercomReady);
      } else {
          setTimeout(waitForIntercomReady, 1000);
      }
      
  })();
</script>

  <script>
    // Đảm bảo script này chạy sau khi index.js và components.js đã được load
    function initializeContactPage() {
      const contactForm = document.getElementById('contactForm');
      const contactMessageInput = document.getElementById('contactMessage');
      const messageErrorElement = document.getElementById('messageError');
      const submitButton = document.getElementById('submitContactBtn');
      const formFeedbackElement = document.getElementById('formFeedback');

      // Kiểm tra các hàm và biến toàn cục từ index.js
      if (typeof API_BASE_URL === 'undefined' || typeof getSession !== 'function' || typeof checkAuthTokenForPage !== 'function') {
        console.error("Một số hàm hoặc biến toàn cục từ index.js chưa sẵn sàng. Trang liên hệ có thể không hoạt động đúng.");
        formFeedbackElement.innerHTML = '<p class="text-red-600">Lỗi tải trang. Vui lòng làm mới lại.</p>';
        if (submitButton) submitButton.disabled = true;
        return;
      }

      // Kiểm tra đăng nhập khi trang tải
      if (!checkAuthTokenForPage()) {
        // checkAuthTokenForPage đã xử lý chuyển hướng nếu cần
        // Có thể hiển thị thông báo yêu cầu đăng nhập nếu muốn
        formFeedbackElement.innerHTML = '<p class="text-yellow-600">Vui lòng <a href="/Customer/templates/login.html" class="font-bold hover:underline">đăng nhập</a> để gửi liên hệ.</p>';
        if (submitButton) submitButton.disabled = true; // Vô hiệu hóa nút gửi nếu chưa đăng nhập
        return; // Dừng ở đây nếu chưa đăng nhập
      }


      if (contactForm && contactMessageInput && submitButton) {
        contactForm.addEventListener('submit', async function (event) {
          event.preventDefault();
          formFeedbackElement.innerHTML = ''; // Xóa thông báo cũ
          messageErrorElement.classList.add('hidden');

          const message = contactMessageInput.value.trim();

          // Validate message length
          if (message.length < 10 || message.length > 2000) {
            messageErrorElement.classList.remove('hidden');
            contactMessageInput.focus();
            return;
          }

          const token = getSession('token');
          if (!token) {
            formFeedbackElement.innerHTML = '<p class="text-red-600">Lỗi: Bạn chưa đăng nhập hoặc phiên đã hết hạn. Vui lòng <a href="/Customer/templates/login.html" class="font-bold hover:underline">đăng nhập lại</a>.</p>';
            return;
          }

          const originalButtonText = submitButton.innerHTML;
          submitButton.disabled = true;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang gửi...';

          const contactData = {
            message: message
          };

          try {
            const response = await fetch(`${API_BASE_URL}/Contacts`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(contactData)
            });

            if (response.ok) {
              const result = await response.json(); // ContactDto
              formFeedbackElement.innerHTML = `<p class="text-green-600 font-semibold">Yêu cầu liên hệ của bạn đã được gửi thành công! Chúng tôi sẽ phản hồi sớm nhất có thể. (ID: ${result.contactID})</p>`;
              contactForm.reset(); // Xóa form sau khi gửi thành công
            } else {
              const errorData = await response.json().catch(() => ({ message: "Không thể gửi yêu cầu. Vui lòng thử lại." }));
              let errorMessage = `Lỗi ${response.status}: ${errorData.message || "Đã có lỗi xảy ra."}`;
              if (response.status === 400 && errorData.errors) { // Xử lý lỗi validation chi tiết từ ASP.NET Core
                const validationErrors = Object.values(errorData.errors).flat().join('<br>');
                errorMessage = `Lỗi dữ liệu: <br>${validationErrors}`;
              } else if (response.status === 401) {
                errorMessage = "Phiên đăng nhập không hợp lệ hoặc đã hết hạn. Vui lòng đăng nhập lại.";
              }
              formFeedbackElement.innerHTML = `<p class="text-red-600">${errorMessage}</p>`;
            }
          } catch (error) {
            console.error('Lỗi khi gửi liên hệ:', error);
            formFeedbackElement.innerHTML = '<p class="text-red-600">Đã xảy ra lỗi kết nối máy chủ. Vui lòng thử lại sau.</p>';
          } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
          }
        });
      } else {
        console.error("Không tìm thấy form liên hệ hoặc các trường cần thiết.");
      }
    }

    // Chạy hàm khởi tạo sau khi DOM đã sẵn sàng và các script khác đã load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeContactPage);
    } else {
      // DOMContentLoaded đã xảy ra, components.js có thể vẫn đang load
      setTimeout(initializeContactPage, 200); // Chờ 200ms để components load xong
    }
    
  </script>
</body>

</html>