<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liên Hệ - ShopX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="icon" type="image/png" href="/Customer/assets/images/logo.jpg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    /* Chatbot Animations */
@keyframes bounce-in {
    0% { transform: scale(0.3) rotate(-45deg); opacity: 0; }
    50% { transform: scale(1.05) rotate(-10deg); }
    70% { transform: scale(0.9) rotate(5deg); }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

@keyframes pulse-slow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

#botpress-chat-toggle {
    animation: bounce-in 0.6s ease-out;
}

#chat-status {
    animation: pulse-slow 2s infinite;
}

/* ✅ Responsive adjustments */
@media (max-width: 768px) {
    #botpress-chat-toggle {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
    }
    
    #botpress-chat-toggle i {
        font-size: 1.25rem;
    }
}

/* ✅ High contrast mode support */
@media (prefers-contrast: high) {
    #botpress-chat-toggle {
        border: 2px solid white;
    }
}

/* ✅ Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    #botpress-chat-toggle {
        animation: none;
        transition: none;
    }
    
    #chat-status {
        animation: none;
    }
}
  </style>
</head>

<body class="bg-gray-50 font-sans">
  <!-- Header Container -->
  <div id="header-container"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Contact Hero -->
    <section class="relative bg-gradient-to-r from-blue-600 to-indigo-700 py-20 mb-12 rounded-lg shadow-xl">
      <div class="container mx-auto px-4 text-center text-white">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 animate-fade-in-down">Liên hệ với chúng tôi</h1>
        <p class="text-lg md:text-xl animate-fade-in-up">Mọi thắc mắc và yêu cầu hỗ trợ, vui lòng liên hệ qua thông tin
          bên dưới hoặc gửi tin nhắn cho chúng tôi.</p>
      </div>
    </section>

    <!-- Contact Content -->
    <section class="py-16 bg-white rounded-lg shadow-xl">
      <div class="container mx-auto px-4">
        <div class="flex flex-col lg:flex-row gap-12">
          <!-- Contact Form -->
          <div class="lg:w-2/3 xl:w-1/2">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Gửi tin nhắn cho chúng tôi</h2>
            <form id="contactForm" class="space-y-6">
              <div>
                <label for="contactMessage" class="block text-sm font-medium text-gray-700 mb-2">Nội dung liên hệ <span
                    class="text-red-500">*</span></label>
                <textarea id="contactMessage" name="message" rows="6" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow shadow-sm"
                  placeholder="Nhập nội dung bạn muốn gửi... (tối thiểu 10 ký tự)"></textarea>
                <p id="messageError" class="text-red-500 text-xs mt-1 hidden">Nội dung phải từ 10 đến 2000 ký tự.</p>
              </div>
              <button type="submit" id="submitContactBtn"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-paper-plane mr-2"></i>Gửi tin nhắn
              </button>
              <div id="formFeedback" class="mt-4 text-sm"></div>
            </form>
          </div>

          <!-- Contact Info -->
          <div class="lg:w-1/3 xl:w-1/2 mt-12 lg:mt-0">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Thông tin liên hệ</h2>
            <div class="space-y-6">
              <div class="flex items-start p-4 bg-indigo-50 rounded-lg shadow">
                <div class="bg-indigo-100 p-3 rounded-full mr-4 flex-shrink-0">
                  <i class="fas fa-map-marker-alt text-indigo-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-bold text-lg mb-1">Địa chỉ cửa hàng</h3>
                  <p class="text-gray-600">11 Lý Thường Kiệt, P. Phú Nhuận, TP. Huế</p>
                </div>
              </div>

              <div class="flex items-start p-4 bg-indigo-50 rounded-lg shadow">
                <div class="bg-indigo-100 p-3 rounded-full mr-4 flex-shrink-0">
                  <i class="fas fa-phone-alt text-indigo-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg text-gray-700 mb-1">Điện thoại</h3>
                  <p class="text-gray-600">1900 1234 (Hỗ trợ 24/7)</p>
                </div>
              </div>

              <div class="flex items-start p-4 bg-indigo-50 rounded-lg shadow">
                <div class="bg-indigo-100 p-3 rounded-full mr-4 flex-shrink-0">
                  <i class="fas fa-envelope text-indigo-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg text-gray-700 mb-1">Email</h3>
                  <p class="text-gray-600"><a href="mailto:support@shopx.vn"
                      class="hover:underline">support@shopx.vn</a></p>
                </div>
              </div>
            </div>

            <div class="mt-12">
              <h3 class="font-bold text-lg mb-4">Theo dõi chúng tôi</h3>
              <div class="flex space-x-4">
                <a href="https://www.facebook.com/quocminh20" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition">
                  <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="bg-pink-600 text-white p-3 rounded-full hover:bg-pink-700 transition">
                  <i class="fab fa-instagram"></i>
                </a>
                <a href="#" class="bg-blue-400 text-white p-3 rounded-full hover:bg-blue-500 transition">
                  <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="bg-red-600 text-white p-3 rounded-full hover:bg-red-700 transition">
                  <i class="fab fa-youtube"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer Container -->
  <div id="footer-container"></div>
  

  <!-- Chatbot -->
<!-- ✅ ENHANCED Chatbot với better UI -->
<div class="fixed bottom-6 right-6 z-50">
  <!-- Chat Toggle Button -->
  <button id="botpress-chat-toggle" 
          class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-300" 
          aria-label="Chat với ShopX AI"
          title="Chat với ShopX AI">
      <i id="chat-icon" class="fas fa-robot text-2xl"></i>
      <i id="loading-icon" class="fas fa-spinner fa-spin text-2xl hidden"></i>
  </button>
  
  <!-- ✅ NEW: Chat Status Indicator -->
  <div id="chat-status" class="absolute -top-2 -right-2 w-4 h-4 bg-green-500 rounded-full border-2 border-white hidden animate-pulse"></div>
  
  <!-- ✅ NEW: Notification Badge -->
  <div id="chat-notification" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden">
    !
  </div>
  
  <!-- Botpress Scripts -->
  <script src="https://cdn.botpress.cloud/webchat/v2.5/inject.js"></script>
  <script src="https://files.bpcontent.cloud/2025/05/16/06/20250516065823-OF1G5JIH.js"></script>
</div>

  <!-- Scripts -->
  <script src="../assets/js/index.js"></script>
  <script type="module" src="../assets/js/components.js"></script>
  <script>
    // ✅ ENHANCED Botpress Configuration với Error Handling
    (function() {
        'use strict';
        
        let botpressReady = false;
        let chatToggleButton;
        let chatIcon;
        let loadingIcon;
        let chatStatus;
        
        // Wait for DOM to be ready
        function initializeChatbot() {
            chatToggleButton = document.getElementById('botpress-chat-toggle');
            chatIcon = document.getElementById('chat-icon');
            loadingIcon = document.getElementById('loading-icon');
            chatStatus = document.getElementById('chat-status');
            
            if (!chatToggleButton) {
                console.error('Chatbot toggle button not found');
                return;
            }
            
            // Show loading state
            showLoadingState();
            
            // Initialize Botpress with error handling
            initializeBotpress();
            
            // Bind events
            bindChatEvents();
        }
        
        function showLoadingState() {
            if (chatIcon && loadingIcon) {
                chatIcon.classList.add('hidden');
                loadingIcon.classList.remove('hidden');
            }
            
            if (chatToggleButton) {
                chatToggleButton.disabled = true;
                chatToggleButton.title = 'Đang khởi tạo chatbot...';
            }
        }
        
        function showReadyState() {
            if (chatIcon && loadingIcon) {
                chatIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
            }
            
            if (chatToggleButton) {
                chatToggleButton.disabled = false;
                chatToggleButton.title = 'Chat với ShopX AI';
            }
            
            if (chatStatus) {
                chatStatus.classList.remove('hidden');
            }
            
            botpressReady = true;
        }
        
        function showErrorState() {
            if (chatIcon && loadingIcon) {
                chatIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
                chatIcon.className = 'fas fa-exclamation-triangle text-2xl text-red-300';
            }
            
            if (chatToggleButton) {
                chatToggleButton.disabled = true;
                chatToggleButton.title = 'Chatbot không khả dụng';
                chatToggleButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                chatToggleButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }
        
        async function initializeBotpress() {
            try {
                // Check if Botpress WebChat is available
                if (typeof window.botpressWebChat === 'undefined') {
                    throw new Error('Botpress WebChat not loaded');
                }
                
                // ✅ ENHANCED: Get user info if logged in
                const userInfo = getUserInfo();
                
                // Initialize with enhanced config
                await window.botpressWebChat.init({
                    botId: "9c478974-8f3b-4df2-ad85-28261b16c4ae",
                    clientId: "9c478974-8f3b-4df2-ad85-28261b16c4ae",
                    hostUrl: "https://mediafiles.botpress.cloud",
                    messagingUrl: "https://messaging.botpress.cloud",
                    botName: "ShopX Bot",
                    fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
                    showConversationsButton: false,
                    enableReset: true,
                    
                    // ✅ NEW: User context integration
                    ...(userInfo && {
                        userId: userInfo.userId,
                        userName: userInfo.fullName,
                        userEmail: userInfo.email
                    }),
                    
                    // ✅ NEW: Styling customization
                    stylesheet: `
                        .bpw-chat-container {
                            border-radius: 12px !important;
                            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
                        }
                        .bpw-header {
                            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
                            border-radius: 12px 12px 0 0 !important;
                        }
                        .bpw-send-button {
                            background-color: #2563eb !important;
                        }
                    `,
                    
                    // ✅ NEW: Welcome message
                    welcomeMessage: userInfo ? 
                        `Xin chào ${userInfo.fullName}! Tôi là ShopX Bot, có thể giúp gì cho bạn hôm nay?` :
                        'Xin chào! Tôi là ShopX Bot, có thể giúp gì cho bạn hôm nay?'
                });
                
                console.log('✅ Botpress WebChat initialized successfully');
                showReadyState();
                
                // ✅ Setup event listeners for chat events
                setupChatEventListeners();
                
            } catch (error) {
                console.error('❌ Botpress initialization failed:', error);
                showErrorState();
                
                // ✅ Fallback: Show contact form link
                if (chatToggleButton) {
                    chatToggleButton.addEventListener('click', () => {
                        alert('Chatbot tạm thời không khả dụng. Vui lòng sử dụng form liên hệ phía trên.');
                    });
                }
            }
        }
        
        function getUserInfo() {
            try {
                // ✅ Integration với session management từ index.js
                if (typeof getSession === 'function') {
                    const token = getSession('token');
                    const userInfo = getSession('userInfo');
                    
                    if (token && userInfo) {
                        return {
                            userId: userInfo.userID || userInfo.userId,
                            fullName: userInfo.fullName,
                            email: userInfo.email
                        };
                    }
                }
            } catch (error) {
                console.warn('Could not get user info for chatbot:', error);
            }
            return null;
        }
        
        function setupChatEventListeners() {
            try {
                // ✅ Listen for chat open/close events
                window.botpressWebChat.onEvent((event) => {
                    switch (event.type) {
                        case 'webchat:opened':
                            console.log('💬 Chat opened');
                            // Hide notification badge
                            const notification = document.getElementById('chat-notification');
                            if (notification) {
                                notification.classList.add('hidden');
                            }
                            break;
                            
                        case 'webchat:closed':
                            console.log('💬 Chat closed');
                            break;
                            
                        case 'message:received':
                            console.log('📨 New message received');
                            // Show notification if chat is closed
                            const notificationBadge = document.getElementById('chat-notification');
                            if (notificationBadge && !isChatOpen()) {
                                notificationBadge.classList.remove('hidden');
                            }
                            break;
                    }
                });
            } catch (error) {
                console.warn('Could not setup chat event listeners:', error);
            }
        }
        
        function bindChatEvents() {
            if (!chatToggleButton) return;
            
            chatToggleButton.addEventListener('click', () => {
                if (!botpressReady) {
                    console.warn('Botpress not ready yet');
                    return;
                }
                
                try {
                    window.botpressWebChat.sendEvent({ type: 'toggle' });
                } catch (error) {
                    console.error('Error toggling chat:', error);
                    alert('Có lỗi xảy ra khi mở chatbot. Vui lòng thử lại.');
                }
            });
            
            // ✅ NEW: Keyboard shortcut (Ctrl + Alt + C)
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.altKey && e.key === 'c' && botpressReady) {
                    e.preventDefault();
                    window.botpressWebChat.sendEvent({ type: 'toggle' });
                }
            });
        }
        
        function isChatOpen() {
            try {
                return window.botpressWebChat && window.botpressWebChat.isOpen();
            } catch (error) {
                return false;
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChatbot);
        } else {
            // DOM already loaded, wait a bit for other scripts
            setTimeout(initializeChatbot, 500);
        }
        
        // ✅ Global error handler for chatbot
        window.addEventListener('error', (event) => {
            if (event.message && event.message.includes('botpress')) {
                console.error('Botpress error detected:', event.error);
                showErrorState();
            }
        });
        
    })();
    </script>
  <script>
    // Đảm bảo script này chạy sau khi index.js và components.js đã được load
    function initializeContactPage() {
      const contactForm = document.getElementById('contactForm');
      const contactMessageInput = document.getElementById('contactMessage');
      const messageErrorElement = document.getElementById('messageError');
      const submitButton = document.getElementById('submitContactBtn');
      const formFeedbackElement = document.getElementById('formFeedback');

      // Kiểm tra các hàm và biến toàn cục từ index.js
      if (typeof API_BASE_URL === 'undefined' || typeof getSession !== 'function' || typeof checkAuthTokenForPage !== 'function') {
        console.error("Một số hàm hoặc biến toàn cục từ index.js chưa sẵn sàng. Trang liên hệ có thể không hoạt động đúng.");
        formFeedbackElement.innerHTML = '<p class="text-red-600">Lỗi tải trang. Vui lòng làm mới lại.</p>';
        if (submitButton) submitButton.disabled = true;
        return;
      }

      // Kiểm tra đăng nhập khi trang tải
      if (!checkAuthTokenForPage()) {
        // checkAuthTokenForPage đã xử lý chuyển hướng nếu cần
        // Có thể hiển thị thông báo yêu cầu đăng nhập nếu muốn
        formFeedbackElement.innerHTML = '<p class="text-yellow-600">Vui lòng <a href="/Customer/templates/login.html" class="font-bold hover:underline">đăng nhập</a> để gửi liên hệ.</p>';
        if (submitButton) submitButton.disabled = true; // Vô hiệu hóa nút gửi nếu chưa đăng nhập
        return; // Dừng ở đây nếu chưa đăng nhập
      }


      if (contactForm && contactMessageInput && submitButton) {
        contactForm.addEventListener('submit', async function (event) {
          event.preventDefault();
          formFeedbackElement.innerHTML = ''; // Xóa thông báo cũ
          messageErrorElement.classList.add('hidden');

          const message = contactMessageInput.value.trim();

          // Validate message length
          if (message.length < 10 || message.length > 2000) {
            messageErrorElement.classList.remove('hidden');
            contactMessageInput.focus();
            return;
          }

          const token = getSession('token');
          if (!token) {
            formFeedbackElement.innerHTML = '<p class="text-red-600">Lỗi: Bạn chưa đăng nhập hoặc phiên đã hết hạn. Vui lòng <a href="/Customer/templates/login.html" class="font-bold hover:underline">đăng nhập lại</a>.</p>';
            return;
          }

          const originalButtonText = submitButton.innerHTML;
          submitButton.disabled = true;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang gửi...';

          const contactData = {
            message: message
          };

          try {
            const response = await fetch(`${API_BASE_URL}/Contacts`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(contactData)
            });

            if (response.ok) {
              const result = await response.json(); // ContactDto
              formFeedbackElement.innerHTML = `<p class="text-green-600 font-semibold">Yêu cầu liên hệ của bạn đã được gửi thành công! Chúng tôi sẽ phản hồi sớm nhất có thể. (ID: ${result.contactID})</p>`;
              contactForm.reset(); // Xóa form sau khi gửi thành công
            } else {
              const errorData = await response.json().catch(() => ({ message: "Không thể gửi yêu cầu. Vui lòng thử lại." }));
              let errorMessage = `Lỗi ${response.status}: ${errorData.message || "Đã có lỗi xảy ra."}`;
              if (response.status === 400 && errorData.errors) { // Xử lý lỗi validation chi tiết từ ASP.NET Core
                const validationErrors = Object.values(errorData.errors).flat().join('<br>');
                errorMessage = `Lỗi dữ liệu: <br>${validationErrors}`;
              } else if (response.status === 401) {
                errorMessage = "Phiên đăng nhập không hợp lệ hoặc đã hết hạn. Vui lòng đăng nhập lại.";
              }
              formFeedbackElement.innerHTML = `<p class="text-red-600">${errorMessage}</p>`;
            }
          } catch (error) {
            console.error('Lỗi khi gửi liên hệ:', error);
            formFeedbackElement.innerHTML = '<p class="text-red-600">Đã xảy ra lỗi kết nối máy chủ. Vui lòng thử lại sau.</p>';
          } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
          }
        });
      } else {
        console.error("Không tìm thấy form liên hệ hoặc các trường cần thiết.");
      }
    }

    // Chạy hàm khởi tạo sau khi DOM đã sẵn sàng và các script khác đã load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeContactPage);
    } else {
      // DOMContentLoaded đã xảy ra, components.js có thể vẫn đang load
      setTimeout(initializeContactPage, 200); // Chờ 200ms để components load xong
    }
  </script>
</body>

</html>