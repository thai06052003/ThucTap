<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt ƒê∆°n h√†ng - ShopX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" type="image/png" href="/Customer/assets/images/logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css"> <!-- CSS chung c·ªßa Customer -->
    <style>
        /* Copy c√°c style cho status-badge v√† action-button t·ª´ orders.html ho·∫∑c list.html (Admin) */
        .status-badge {
            padding: 0.25em 0.6em;
            border-radius: 0.25rem;
            font-size: 0.875em;
            /* text-sm */
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            display: inline-block;
            min-width: 120px;
        }

        .status-cho-xac-nhan {
            background-color: #fef3c7;
            color: #b45309;
        }

        .status-dang-xu-ly {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-dang-giao {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-da-giao {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-yeu-cau-tra-hang-hoan-tien {
            background-color: #fffbeb;
            color: #b45309;
        }

        .status-da-hoan-tien {
            background-color: #ede9fe;
            color: #5b21b6;
        }

        .status-da-huy {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-default {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .action-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            /* rounded-md */
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
        }

        .action-button i {
            margin-right: 0.35rem;
        }

        /* N√∫t H·ªßy ƒê∆°n H√†ng (Customer) */
        .customer-cancel-order-btn {
            background-color: #fecaca;
            color: #b91c1c;
            /* red-200, red-700 */
        }

        .customer-cancel-order-btn:hover {
            background-color: #fca5a5;
        }

        /* N√∫t Y√™u C·∫ßu Tr·∫£ H√†ng (Customer) */
        .customer-return-request-btn {
            background-color: #ffedd5;
            color: #c2410c;
            /* orange-100, orange-700 */
        }

        .customer-return-request-btn:hover {
            background-color: #fed7aa;
        }


        .info-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .info-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .info-item>span:first-child {
            font-weight: 500;
            color: #6b7280;
        }

        /* Label */
        .info-item>span:last-child {
            color: #1f2937;
        }

        /* Value */

        .product-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-image-detail {
            width: 5rem;
            height: 5rem;
            object-fit: cover;
            border-radius: 0.375rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .product-details {
            flex-grow: 1;
        }

        .product-name-detail {
            font-weight: 600;
            color: #111827;
            display: block;
            margin-bottom: 0.25rem;
        }

        .product-category-detail {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .product-shop-detail {
            font-size: 0.875rem;
            color: #4f46e5;
            margin-bottom: 0.25rem;
        }

        /* Indigo for shop */
        .product-quantity-detail {
            font-size: 0.875rem;
            color: #4b5563;
        }

        .product-price-detail {
            text-align: right;
            font-size: 0.875rem;
            color: #1f2937;
        }

        .product-linetotal-detail {
            text-align: right;
            font-weight: 600;
            color: #1f2937;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <div id="header-container"></div>

    <main class="container mx-auto px-4 py-8 min-h-[calc(100vh-200px)]">
        <nav class="text-sm mb-6" aria-label="Breadcrumb">
            <ol class="list-none p-0 inline-flex">
                <li class="flex items-center">
                    <a href="/Customer/index.html" class="text-blue-600 hover:underline">Trang ch·ªß</a>
                    <i class="fas fa-chevron-right fa-xs mx-2 text-gray-500"></i>
                </li>
                <li class="flex items-center">
                    <a href="/Customer/templates/orders.html" class="text-blue-600 hover:underline">ƒê∆°n h√†ng c·ªßa t√¥i</a>
                    <i class="fas fa-chevron-right fa-xs mx-2 text-gray-500"></i>
                </li>
                <li class="text-gray-500" aria-current="page">Chi ti·∫øt ƒë∆°n h√†ng <span
                        id="breadcrumbOrderDetailId"></span></li>
            </ol>
        </nav>

        <div id="customerOrderDetailContainer" class="bg-white p-4 md:p-8 rounded-lg shadow-xl">
            <!-- Loading State -->
            <div id="customerLoadingOrderDetail" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-indigo-500 text-4xl"></i>
                <p class="mt-3 text-gray-600">ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng...</p>
            </div>

            <!-- Error State -->
            <div id="customerErrorOrderDetail" class="hidden text-center py-12">
                <i class="fas fa-exclamation-circle text-red-500 text-4xl"></i>
                <p class="mt-3 text-red-600" id="customerErrorMessageDetail"></p>
                <a href="/Customer/templates/orders.html"
                    class="mt-6 inline-block bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition">
                    Quay l·∫°i Danh s√°ch ƒê∆°n h√†ng
                </a>
            </div>

            <!-- Content State (hidden by default) -->
            <div id="customerContentOrderDetail" class="hidden">
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-4 border-b border-gray-200">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                            Chi ti·∫øt ƒê∆°n h√†ng #<span id="detailOrderId"></span>
                        </h1>
                        <p class="text-sm text-gray-500">Ng√†y ƒë·∫∑t: <span id="detailOrderDate"></span></p>
                    </div>
                    <div id="detailOrderStatusBadge" class="mt-3 md:mt-0">
                        <!-- Status badge will be here -->
                    </div>
                </div>

                <div class="info-group">
                    <h2 class="info-title">Th√¥ng tin giao h√†ng</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span>Ng∆∞·ªùi nh·∫≠n:</span>
                            <span id="detailCustomerName"></span>
                        </div>
                        <div class="info-item">
                            <span>S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span id="detailCustomerPhone"></span>
                        </div>
                        <div class="info-item md:col-span-2">
                            <span>ƒê·ªãa ch·ªâ giao h√†ng:</span>
                            <span id="detailShippingAddress"></span>
                        </div>
                    </div>
                </div>

                <div class="info-group">
                    <h2 class="info-title">S·∫£n ph·∫©m</h2>
                    <div id="detailOrderItemsList" class="divide-y divide-gray-100">
                        <!-- Product items will be rendered here -->
                    </div>
                </div>

                <div class="info-group">
                    <h2 class="info-title">Thanh to√°n</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">T·ªïng ti·ªÅn h√†ng:</span>
                            <span id="detailSubtotal" class="text-gray-800"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <span id="detailShippingFee" class="text-gray-800">Mi·ªÖn ph√≠</span>
                            <!-- Ho·∫∑c gi√° tr·ªã ƒë·ªông -->
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Gi·∫£m gi√° (Code: <span id="detailDiscountCode">Kh√¥ng
                                    c√≥</span>):</span>
                            <span id="detailDiscountAmount" class="text-red-500"></span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between font-bold text-lg">
                            <span class="text-gray-800">T·ªïng thanh to√°n:</span>
                            <span id="detailTotalPayment" class="text-indigo-600"></span>
                        </div>
                    </div>
                </div>

                <div id="customerOrderActionButtons" class="mt-8 flex flex-col sm:flex-row justify-end gap-3">
                    <!-- Customer-specific action buttons will be here -->
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script src="../assets/js/index.js"></script>
    <script type="module" src="../assets/js/components.js"></script>
    <script>
        function initializeOrderDetailPage() {
            const loadingElement = document.getElementById('customerLoadingOrderDetail');
            const errorElement = document.getElementById('customerErrorOrderDetail');
            const errorMessageSpan = document.getElementById('customerErrorMessageDetail');
            const contentElement = document.getElementById('customerContentOrderDetail');

            const breadcrumbIdSpan = document.getElementById('breadcrumbOrderDetailId');
            const orderIdSpan = document.getElementById('detailOrderId');
            const orderDateSpan = document.getElementById('detailOrderDate');
            const statusBadgeContainer = document.getElementById('detailOrderStatusBadge');

            const customerNameSpan = document.getElementById('detailCustomerName');
            const customerPhoneSpan = document.getElementById('detailCustomerPhone');
            const shippingAddressSpan = document.getElementById('detailShippingAddress');

            const itemsListDiv = document.getElementById('detailOrderItemsList');

            const subtotalSpan = document.getElementById('detailSubtotal');
            const shippingFeeSpan = document.getElementById('detailShippingFee'); // C·∫ßn d·ªØ li·ªáu n·∫øu c√≥
            const discountCodeSpan = document.getElementById('detailDiscountCode');
            const discountAmountSpan = document.getElementById('detailDiscountAmount');
            const totalPaymentSpan = document.getElementById('detailTotalPayment');
            const actionButtonsContainer = document.getElementById('customerOrderActionButtons');

            const ORDER_STATUSES = Object.freeze({
                CHO_XAC_NHAN: "Ch·ªù x√°c nh·∫≠n",
                DANG_XU_LY: "ƒêang x·ª≠ l√Ω",
                DANG_GIAO: "ƒêang giao",
                DA_GIAO: "ƒê√£ giao",
                YEU_CAU_TRA_HANG_HOAN_TIEN: "Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn",
                DA_HOAN_TIEN: "ƒê√£ ho√†n ti·ªÅn",
                DA_HUY: "ƒê√£ h·ªßy"
            });

            if (typeof formatDate !== 'function' || typeof formatCurrency !== 'function' || typeof getSession !== 'function' || typeof API_BASE_URL === 'undefined' || typeof getImageUrl !== 'function') {
                console.error("M·ªôt s·ªë h√†m ho·∫∑c bi·∫øn to√†n c·ª•c t·ª´ index.js ch∆∞a s·∫µn s√†ng.");
                loadingElement.classList.add('hidden');
                errorMessageSpan.textContent = "L·ªói t·∫£i trang. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá h·ªó tr·ª£.";
                errorElement.classList.remove('hidden');
                return;
            }

            function getStatusClass(status) {
                switch (status) {
                    case ORDER_STATUSES.CHO_XAC_NHAN: return 'status-cho-xac-nhan';
                    case ORDER_STATUSES.DANG_XU_LY: return 'status-dang-xu-ly';
                    case ORDER_STATUSES.DANG_GIAO: return 'status-dang-giao';
                    case ORDER_STATUSES.DA_GIAO: return 'status-da-giao';
                    case ORDER_STATUSES.YEU_CAU_TRA_HANG_HOAN_TIEN: return 'status-yeu-cau-tra-hang-hoan-tien';
                    case ORDER_STATUSES.DA_HOAN_TIEN: return 'status-da-hoan-tien';
                    case ORDER_STATUSES.DA_HUY: return 'status-da-huy';
                    default:
                        console.warn(`Tr·∫°ng th√°i kh√¥ng x√°c ƒë·ªãnh trong getStatusClass (detail): "${status}"`);
                        return 'status-default';
                }
            }

            // ‚úÖ S·ª¨A: order-detail.html - updateOrderStatusViaAPI function

async function updateOrderStatusViaAPI(orderId, newStatus, successMessage, refreshCallback) {
    const token = getSession('token');
    if (!token && token != null) { 
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y')
        sessionStorage.clear();
        window.location.assign('/Customer/templates/login.html')
        return;
    }
    
    try {
        // ‚úÖ FIXED: S·ª≠ d·ª•ng endpoint ƒë√∫ng cho Customer
        let apiEndpoint;
        let requestData;
        
        if (newStatus === 'Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn' || newStatus === 'ƒê√£ h·ªßy') {
            // ‚úÖ Customer requests (ho√†n ti·ªÅn, h·ªßy)
            apiEndpoint = `${API_BASE_URL}/Orders/${orderId}/customer-status`;
            requestData = { newStatus: newStatus };
        } else {
            // ‚úÖ General status updates (cho seller/admin - kh√¥ng d√†nh cho customer)
            apiEndpoint = `${API_BASE_URL}/Orders/${orderId}/status`;
            requestData = { newStatus: newStatus };
        }
        
        console.log(`üåê Calling API: ${apiEndpoint}`, requestData);
        
        const response = await fetch(apiEndpoint, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify(requestData)
        });
        
        console.log('üì¶ API Response Status:', response.status);
        
        if (response.ok) {
            const responseData = await response.json();
            console.log('‚úÖ API Response Data:', responseData);
            
            alert(successMessage || responseData.message || `C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng #${orderId} th√†nh c√¥ng!`);
            if (refreshCallback) refreshCallback();
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('‚ùå API Error Response:', errorData);
            
            // ‚úÖ Enhanced error handling
            let errorMessage = 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ƒë∆°n h√†ng';
            
            if (response.status === 400) {
                errorMessage = errorData.message || 'Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin ƒë∆°n h√†ng.';
            } else if (response.status === 401) {
                errorMessage = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                sessionStorage.clear();
                window.location.assign('/Customer/templates/login.html');
                return;
            } else if (response.status === 403) {
                errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y.';
            } else if (response.status === 404) {
                errorMessage = 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ho·∫∑c ƒë∆°n h√†ng ƒë√£ b·ªã x√≥a.';
            } else {
                errorMessage = errorData.message || `L·ªói ${response.status}: ${response.statusText}`;
            }
            
            alert(`L·ªói: ${errorMessage}`);
        }
    } catch (error) {
        console.error('‚ùå Network/Request Error:', error);
        alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
    }
}

            window.customerCancelOrder = (orderId) => {
                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng #${orderId} kh√¥ng?`)) {
                    updateOrderStatusViaAPI(orderId, ORDER_STATUSES.DA_HUY,
                        `ƒê∆°n h√†ng #${orderId} ƒë√£ ƒë∆∞·ª£c y√™u c·∫ßu h·ªßy.`,
                        () => fetchOrderDetail(orderId) // T·∫£i l·∫°i chi ti·∫øt sau khi h·ªßy
                    );
                }
            };

            window.customerRequestReturn = (orderId) => {
                if (confirm(`B·∫°n c√≥ mu·ªën g·ª≠i Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn cho ƒë∆°n h√†ng #${orderId} kh√¥ng?`)) {
                    updateOrderStatusViaAPI(orderId, ORDER_STATUSES.YEU_CAU_TRA_HANG_HOAN_TIEN,
                        `Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn cho ƒë∆°n h√†ng #${orderId} ƒë√£ ƒë∆∞·ª£c g·ª≠i. Shop s·∫Ω li√™n h·ªá v·ªõi b·∫°n.`,
                        () => fetchOrderDetail(orderId)
                    );
                }
            };


            async function fetchOrderDetail(orderId) {
                loadingElement.classList.remove('hidden');
                errorElement.classList.add('hidden');
                contentElement.classList.add('hidden');

                const token = getSession('token');
                if (!token) { /* ... x·ª≠ l√Ω l·ªói token ... */ return; }

                try {
                    const response = await fetch(`${API_BASE_URL}/Orders/${orderId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) {
                        if (response.status === 404) throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng #${orderId}.`);
                        const errorText = await response.text();
                        throw new Error(`L·ªói ${response.status}: ${errorText || "Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng."}`);
                    }
                    const order = await response.json();
                    renderOrderDetail(order);
                    contentElement.classList.remove('hidden');
                } catch (err) {
                    errorMessageSpan.textContent = err.message;
                    errorElement.classList.remove('hidden');
                } finally {
                    loadingElement.classList.add('hidden');
                }
            }

            function renderOrderDetail(order) {
                breadcrumbIdSpan.textContent = `#${order.orderID}`;
                orderIdSpan.textContent = order.orderID;
                orderDateSpan.textContent = formatDate(new Date(order.orderDate));

                statusBadgeContainer.innerHTML = `<span class="status-badge ${getStatusClass(order.status)}">${order.status}</span>`;

                shippingAddressSpan.textContent = order.shippingAddress;
                if (order.customerInfo) {
                    customerNameSpan.textContent = order.customerInfo.fullName || 'N/A';
                    customerPhoneSpan.textContent = order.customerInfo.phone || 'N/A';
                }

                itemsListDiv.innerHTML = ''; // Clear old items
                order.items.forEach(item => {
                    itemsListDiv.innerHTML += `
                        <div class="product-item">
                            <img src="${getImageUrl(item.productImageURL)}" alt="${item.productName}" class="product-image-detail">
                            <div class="product-details">
                                <a href="/Customer/templates/product-detail.html?productId=${item.productID}" 
                                                class="mb-2 text-lg text-gray-800 leading-tight hover:text-indigo-600 rounded-full ${!item.isActive ? 'no-event' : ''}">
                                                ${item.productName}
                                                ${!item.isActive ? `<span class="text-xs font-medium px-3 py-1 ml-8 bg-gray-500 rounded-full w-24 text-center text-white">ƒê√£ ng·ª´ng b√°n</span>` : ''}
                                                </a>
                                <p class="product-category-detail">Ph√¢n lo·∫°i: ${item.categoryName || 'Ch∆∞a ph√¢n lo·∫°i'}</p>
                                ${item.shopName && item.shopName !== "N/A" ? `<p class="product-shop-detail">Shop: ${item.shopName}</p>` : ''}
                                <p class="product-quantity-detail">S·ªë l∆∞·ª£ng: ${item.quantity}</p>
                            </div>
                            <div class="ml-auto text-right">
                                <p class="product-price-detail">${formatCurrency(item.unitPrice)}</p>
                                <p class="product-linetotal-detail">${formatCurrency(item.lineTotal)}</p>
                            </div>
                        </div>
                    `;
                });

                subtotalSpan.textContent = formatCurrency(order.totalAmount);
                // Ph√≠ v·∫≠n chuy·ªÉn v√† gi·∫£m gi√° c√≥ th·ªÉ c·∫ßn t√≠nh to√°n ho·∫∑c l·∫•y t·ª´ API n·∫øu c√≥
                const discountApplied = order.totalAmount - order.totalPayment;
                discountCodeSpan.textContent = order.discountCode || 'Kh√¥ng c√≥';
                discountAmountSpan.textContent = `- ${formatCurrency(discountApplied)}`;
                totalPaymentSpan.textContent = formatCurrency(order.totalPayment);

                // Render Action Buttons cho Customer
                // ‚úÖ H·ªßy ƒë∆°n h√†ng (ch·ªâ khi ch·ªù x√°c nh·∫≠n ho·∫∑c ƒëang x·ª≠ l√Ω)
                 if (order.status === ORDER_STATUSES.CHO_XAC_NHAN || order.status === ORDER_STATUSES.DANG_XU_LY) {
        actionButtonsContainer.innerHTML += `
            <button onclick="customerCancelOrder(${order.orderID})" 
                    class="action-button customer-cancel-order-btn"
                    title="H·ªßy ƒë∆°n h√†ng n√†y">
                <i class="fas fa-times-circle"></i>H·ªßy ƒê∆°n H√†ng
            </button>`;
    }
            
                // ‚úÖ FIXED: Y√™u c·∫ßu ho√†n ti·ªÅn (ch·ªâ khi ƒë√£ giao v√† trong v√≤ng 3 ng√†y)
    if (order.status === ORDER_STATUSES.DA_GIAO && order.orderDate) {
        const daysSinceDelivery = getDateDifference(order.orderDate);
        const canReturn = daysSinceDelivery <= 3;
        
        console.log('üîÑ Return eligibility check:', {
            daysSinceDelivery,
            canReturn,
            orderDate: order.orderDate
        });
        
        if (canReturn) {
            const timeRemaining = getReturnTimeRemaining(order.orderDate);
            
            actionButtonsContainer.innerHTML += `
                <button onclick="customerRequestReturn(${order.orderID})" 
                        class="action-button customer-return-request-btn ml-0 sm:ml-3 mt-2 sm:mt-0"
                        title="${timeRemaining}">
                    <i class="fas fa-undo-alt"></i>Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn
                    <span class="text-xs block">(${timeRemaining})</span>
                </button>`;
                
            // ‚úÖ ƒê√°nh gi√° s·∫£n ph·∫©m
            actionButtonsContainer.innerHTML += `
                <button onclick="window.location.href='/Customer/templates/review.html?orderId=${order.orderID}'" 
                        class="action-button bg-indigo-600 text-white hover:bg-indigo-700 ml-0 sm:ml-3 mt-2 sm:mt-0">
                    <i class="fas fa-star"></i>ƒê√°nh Gi√° S·∫£n Ph·∫©m
                </button>`;
        } else {
            // ‚úÖ Hi·ªÉn th·ªã th√¥ng b√°o ƒë√£ h·∫øt h·∫°n
            actionButtonsContainer.innerHTML += `
                <div class="text-sm text-gray-500 ml-0 sm:ml-3 mt-2 sm:mt-0 p-2 bg-gray-100 rounded">
                    <i class="fas fa-clock mr-1"></i>
                    ƒê√£ h·∫øt th·ªùi h·∫°n y√™u c·∫ßu ho√†n ti·ªÅn (qu√° 3 ng√†y)
                </div>`;
        }
    }
    
    // ‚úÖ Mua l·∫°i (lu√¥n hi·ªÉn th·ªã)
    actionButtonsContainer.innerHTML += `
        <button onclick="window.location.href='/Customer/templates/cart.html?rebuyOrderId=${order.orderID}'" 
                class="action-button bg-gray-200 text-gray-700 hover:bg-gray-300 ml-0 sm:ml-3 mt-2 sm:mt-0">
            <i class="fas fa-redo-alt"></i>Mua L·∫°i
        </button>`;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const orderIdFromUrl = urlParams.get('id');

            if (orderIdFromUrl && !isNaN(orderIdFromUrl)) {
                if (checkAuthTokenForPage()) {
                    fetchOrderDetail(parseInt(orderIdFromUrl));
                } else {
                    loadingElement.classList.add('hidden');
                    errorMessageSpan.textContent = "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem chi ti·∫øt ƒë∆°n h√†ng.";
                    errorElement.classList.remove('hidden');
                }
            } else {
                loadingElement.classList.add('hidden');
                errorMessageSpan.textContent = 'ID ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá.';
                errorElement.classList.remove('hidden');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeOrderDetailPage);
        } else {
            setTimeout(initializeOrderDetailPage, 100); // Ch·ªù ch√∫t cho components.js v√† index.js
        }
    </script>
</body>

</html>