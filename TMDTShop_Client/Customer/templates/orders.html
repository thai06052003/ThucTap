<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i - ShopX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" type="image/png" href="/Customer/assets/images/logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css"> <!-- CSS chung c·ªßa Customer -->
    <style>
        /* Style cho status badges, c√≥ th·ªÉ d√πng chung v·ªõi Admin ho·∫∑c t√πy ch·ªânh */
        .status-badge {
            padding: 0.25em 0.6em;
            border-radius: 0.25rem;
            font-size: 0.8em;
            font-weight: 500;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            display: inline-block;
            min-width: 100px;
            /* Cho ƒë·ªô r·ªông t·ªëi thi·ªÉu */
        }

        .status-cho-xac-nhan {
            background-color: #fef3c7;
            color: #b45309;
        }

        .status-dang-xu-ly {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-dang-giao {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-da-giao {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-yeu-cau-tra-hang-hoan-tien {
            background-color: #fffbeb;
            color: #b45309;
        }

        .status-da-hoan-tien {
            background-color: #ede9fe;
            color: #5b21b6;
        }

        .status-da-huy {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-default {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        /* N√∫t chi ti·∫øt */
        .detail-button {
            background-color: #eff6ff;
            color: #2563eb;
            padding: 0.3rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .detail-button:hover {
            background-color: #dbeafe;
        }

        .detail-button i {
            margin-right: 0.25rem;
        }

        .order-card-action-button {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            /* rounded-sm c·ªßa Tailwind */
            font-size: 0.875rem;
            /* text-sm */
            font-weight: 500;
            /* font-medium */
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            text-align: center;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <!-- Container cho Header, s·∫Ω ƒë∆∞·ª£c components.js ƒëi·ªÅn v√†o -->
    <div id="header-container">
        <!-- N·ªôi dung header s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
    </div>

    <main id="mainContent" class="container mx-auto px-4 py-8">
        <nav class="text-sm mb-6" aria-label="Breadcrumb">
            <ol class="list-none p-0 inline-flex">
                <li class="flex items-center">
                    <a href="/Customer/index.html" class="text-blue-600 hover:underline">Trang ch·ªß</a>
                    <i class="fas fa-chevron-right fa-xs mx-2 text-gray-500"></i>
                </li>
                <li class="text-gray-500" aria-current="page">ƒê∆°n h√†ng c·ªßa t√¥i</li>
            </ol>
        </nav>

        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">ƒê∆°n h√†ng c·ªßa t√¥i</h1>

        <!-- Filters -->
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-6">
            <form id="customerOrderFilterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="customerStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng
                        th√°i</label>
                    <select id="customerStatusFilter" name="status"
                        class="w-full border border-gray-300 px-3 py-2 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        <option value="">T·∫•t c·∫£</option>
                        <!-- Options s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·ªüi JS -->
                    </select>
                </div>
                <div>
                    <label for="customerStartDateFilter" class="block text-sm font-medium text-gray-700 mb-1">T·ª´
                        ng√†y</label>
                    <input type="date" id="customerStartDateFilter" name="startDate"
                        class="w-full border border-gray-300 px-3 py-2 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
                </div>
                <div>
                    <label for="customerEndDateFilter" class="block text-sm font-medium text-gray-700 mb-1">ƒê·∫øn
                        ng√†y</label>
                    <input type="date" id="customerEndDateFilter" name="endDate"
                        class="w-full border border-gray-300 px-3 py-2 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
                </div>
                <div class="sm:col-span-2 lg:col-span-1 flex justify-end items-end">
                    <button type="submit"
                        class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 transition font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 w-full sm:w-auto">
                        <i class="fas fa-filter mr-2"></i>L·ªçc
                    </button>
                </div>
            </form>
        </div>

        <!-- Order List -->
        <div id="customerOrderListContainer" class="space-y-4">
            <div id="customerLoadingOrders" class="text-center py-10">
                <i class="fas fa-spinner fa-spin text-indigo-500 text-3xl"></i>
                <p class="mt-2 text-gray-600">ƒêang t·∫£i ƒë∆°n h√†ng...</p>
            </div>
        </div>

        <div id="customerNoOrders" class="hidden text-center py-10 bg-white rounded-lg shadow-md">
            <i class="fas fa-box-open text-gray-400 text-4xl mb-3"></i>
            <p class="text-gray-600">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
            <a href="/Customer/index.html"
                class="mt-4 inline-block bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition">
                Ti·∫øp t·ª•c mua s·∫Øm
            </a>
        </div>

        <!-- Pagination -->
        <div id="customerPaginationContainer"
            class="hidden flex flex-col sm:flex-row justify-between items-center mt-8 text-sm text-gray-600">
            <div id="customerPaginationInfo" class="mb-2 sm:mb-0">
                Hi·ªÉn th·ªã <span id="customerCurrentPageInfo" class="font-medium">0</span> / <span
                    id="customerTotalPagesInfo" class="font-medium">0</span> trang
                (T·ªïng <span id="customerTotalItemsInfo" class="font-medium">0</span> ƒë∆°n h√†ng)
            </div>
            <div class="flex items-center space-x-1">
                <button id="customerPrevPageBtn"
                    class="bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 font-medium py-2 px-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="flex items-center">
                    <input type="number" id="customerPageInput" min="1"
                        class="p-2 border border-gray-300 rounded-md w-16 text-center shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <button id="customerGoToPageBtn"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-3 rounded-md ml-1 transition-colors">ƒêi</button>
                </div>
                <button type="button" id="customerNextPageBtn"
                    class="bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 font-medium py-2 px-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Container cho Footer, s·∫Ω ƒë∆∞·ª£c components.js ƒëi·ªÅn v√†o -->
    <div id="footer-container">
        <!-- N·ªôi dung footer s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
    </div>

    <!-- index.js ph·∫£i ƒë∆∞·ª£c load TR∆Ø·ªöC components.js v√† script c·ªßa trang n√†y -->
    <script src="../assets/js/index.js"></script>
    <script type="module" src="../assets/js/components.js"></script>
    <script src="../assets/js/rebuy-handler.js"></script>
    <script>
        // ƒê·∫£m b·∫£o r·∫±ng script n√†y ch·∫°y SAU KHI index.js v√† components.js ƒë√£ th·ª±c thi
        // v√† DOMContentLoaded ƒë√£ ho√†n t·∫•t.
        // components.js s·∫Ω load header/footer, index.js s·∫Ω ƒë·ªãnh nghƒ©a c√°c h√†m to√†n c·ª•c.

        // B·ªçc trong m·ªôt h√†m ƒë·ªÉ ƒë·∫£m b·∫£o c√°c h√†m t·ª´ index.js ƒë√£ s·∫µn s√†ng
        function initializeCustomerOrdersPage() {
            // DOM Elements
            const orderListContainer = document.getElementById('customerOrderListContainer');
            const loadingOrdersElement = document.getElementById('customerLoadingOrders');
            const noOrdersElement = document.getElementById('customerNoOrders');

            const filterForm = document.getElementById('customerOrderFilterForm');
            const statusFilter = document.getElementById('customerStatusFilter');
            const startDateFilter = document.getElementById('customerStartDateFilter');
            const endDateFilter = document.getElementById('customerEndDateFilter');

            const paginationContainer = document.getElementById('customerPaginationContainer');
            const paginationInfoElement = document.getElementById('customerPaginationInfo');
            const currentPageInfoElement = document.getElementById('customerCurrentPageInfo');
            const totalPagesInfoElement = document.getElementById('customerTotalPagesInfo');
            const totalItemsInfoElement = document.getElementById('customerTotalItemsInfo');
            const prevPageBtn = document.getElementById('customerPrevPageBtn');
            const nextPageBtn = document.getElementById('customerNextPageBtn');
            const pageInput = document.getElementById('customerPageInput');
            const goToPageBtn = document.getElementById('customerGoToPageBtn');

            const relatedProductsGridEl = document.getElementById('relatedProductsGrid');

            let currentProductData = null;
            let currentPage = 1;
            const DEFAULT_PAGE_SIZE = 5;

            const ORDER_STATUSES = Object.freeze({
                CHO_XAC_NHAN: "Ch·ªù x√°c nh·∫≠n",
                DANG_XU_LY: "ƒêang x·ª≠ l√Ω",
                DANG_GIAO: "ƒêang giao",
                DA_GIAO: "ƒê√£ giao",
                YEU_CAU_TRA_HANG_HOAN_TIEN: "Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn",
                DA_HOAN_TIEN: "ƒê√£ ho√†n ti·ªÅn",
                DA_HUY: "ƒê√£ h·ªßy"
            });
            const ALL_VALID_STATUSES_FOR_FILTER = Object.values(ORDER_STATUSES);

            // Ki·ªÉm tra xem c√°c h√†m t·ª´ index.js c√≥ t·ªìn t·∫°i kh√¥ng
            if (typeof formatDate !== 'function' || typeof formatCurrency !== 'function' || typeof getSession !== 'function' || typeof API_BASE_URL === 'undefined') {
                console.error("M·ªôt s·ªë h√†m ho·∫∑c bi·∫øn to√†n c·ª•c t·ª´ index.js ch∆∞a s·∫µn s√†ng. Trang c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông ƒë√∫ng.");
                loadingOrdersElement.innerHTML = '<p class="text-red-500 text-center">L·ªói t·∫£i trang. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                return; // D·ª´ng th·ª±c thi n·∫øu c√°c ph·ª• thu·ªôc ch∆∞a s·∫µn s√†ng
            }


            function getStatusClass(status) {
                switch (status) {
                    case ORDER_STATUSES.CHO_XAC_NHAN: return 'status-cho-xac-nhan';
                    case ORDER_STATUSES.DANG_XU_LY: return 'status-dang-xu-ly';
                    case ORDER_STATUSES.DANG_GIAO: return 'status-dang-giao';
                    case ORDER_STATUSES.DA_GIAO: return 'status-da-giao';
                    case ORDER_STATUSES.YEU_CAU_TRA_HANG_HOAN_TIEN: return 'status-yeu-cau-tra-hang-hoan-tien';
                    case ORDER_STATUSES.DA_HOAN_TIEN: return 'status-da-hoan-tien';
                    case ORDER_STATUSES.DA_HUY: return 'status-da-huy';
                    default:
                        console.warn(`Tr·∫°ng th√°i kh√¥ng x√°c ƒë·ªãnh trong getStatusClass: "${status}"`);
                        return 'status-default';
                }
            }

            function populateStatusFilter() {
                ALL_VALID_STATUSES_FOR_FILTER.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                });
            }

           

async function updateOrderStatusViaAPI(orderId, newStatus, successMessage, refreshCallback) {
    const token = getSession('token');
    if (!token && token != null) { 
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y')
        sessionStorage.clear();
        window.location.assign('/Customer/templates/login.html')
        return;
    }
    
    try {
        // ‚úÖ FIXED: S·ª≠ d·ª•ng endpoint ƒë√∫ng cho Customer
        let apiEndpoint;
        let requestData;
        
        if (newStatus === 'Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn' || newStatus === 'ƒê√£ h·ªßy') {
            // ‚úÖ Customer requests (ho√†n ti·ªÅn, h·ªßy)
            apiEndpoint = `${API_BASE_URL}/Orders/${orderId}/customer-status`;
            requestData = { newStatus: newStatus };
        } else {
            // ‚úÖ General status updates (cho seller/admin - kh√¥ng d√†nh cho customer)
            apiEndpoint = `${API_BASE_URL}/Orders/${orderId}/status`;
            requestData = { newStatus: newStatus };
        }
        
        console.log(`üåê Calling API: ${apiEndpoint}`, requestData);
        
        const response = await fetch(apiEndpoint, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify(requestData)
        });
        
        console.log('üì¶ API Response Status:', response.status);
        
        if (response.ok) {
            const responseData = await response.json();
            console.log('‚úÖ API Response Data:', responseData);
            
            alert(successMessage || responseData.message || `C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng #${orderId} th√†nh c√¥ng!`);
            if (refreshCallback) refreshCallback();
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('‚ùå API Error Response:', errorData);
            
            // ‚úÖ Enhanced error handling
            let errorMessage = 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ƒë∆°n h√†ng';
            
            if (response.status === 400) {
                errorMessage = errorData.message || 'Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin ƒë∆°n h√†ng.';
            } else if (response.status === 401) {
                errorMessage = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                sessionStorage.clear();
                window.location.assign('/Customer/templates/login.html');
                return;
            } else if (response.status === 403) {
                errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y.';
            } else if (response.status === 404) {
                errorMessage = 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ho·∫∑c ƒë∆°n h√†ng ƒë√£ b·ªã x√≥a.';
            } else {
                errorMessage = errorData.message || `L·ªói ${response.status}: ${response.statusText}`;
            }
            
            alert(`L·ªói: ${errorMessage}`);
        }
    } catch (error) {
        console.error('‚ùå Network/Request Error:', error);
        alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
    }
}

            // H√†m x·ª≠ l√Ω y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn
            window.customerRequestReturn = (orderId) => {
                if (confirm(`B·∫°n c√≥ mu·ªën g·ª≠i Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn cho ƒë∆°n h√†ng #${orderId} kh√¥ng?`)) {
                    updateOrderStatusViaAPI(orderId, ORDER_STATUSES.YEU_CAU_TRA_HANG_HOAN_TIEN,
                        `Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn cho ƒë∆°n h√†ng #${orderId} ƒë√£ ƒë∆∞·ª£c g·ª≠i. Shop s·∫Ω li√™n h·ªá v·ªõi b·∫°n.`,
                        () => fetchCustomerOrders(page = 1)
                    );
                }
            };
            // H√†m x·ª≠ l√Ω h·ªßy ƒë∆°n h√†ng
            window.customerCancelOrder = (orderId) => {
                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng #${orderId} kh√¥ng?`)) {
                    updateOrderStatusViaAPI(
                        orderId,
                        ORDER_STATUSES.DA_HUY,
                        `ƒê∆°n h√†ng #${orderId} ƒë√£ ƒë∆∞·ª£c h·ªßy th√†nh c√¥ng.`,
                        () => fetchCustomerOrders(1)
                    );
                }
            };

            async function fetchCustomerOrders(page = 1) {
                loadingOrdersElement.classList.remove('hidden');
                orderListContainer.innerHTML = '';
                noOrdersElement.classList.add('hidden');
                paginationContainer.classList.add('hidden');

                currentPage = page;
                const params = new URLSearchParams({
                    pageNumber: currentPage.toString(),
                    pageSize: DEFAULT_PAGE_SIZE.toString()
                });

                const status = statusFilter.value;
                if (status) params.append('Status', status);
                const startDate = startDateFilter.value;
                if (startDate) params.append('StartDate', startDate);
                const endDate = endDateFilter.value;
                if (endDate) params.append('EndDate', endDate);

                const token = getSession('token');
                if (!token) {
                    // checkAuthTokenForPage s·∫Ω x·ª≠ l√Ω redirect, ·ªü ƒë√¢y ch·ªâ d·ª´ng
                    console.log("Kh√¥ng c√≥ token, kh√¥ng t·∫£i ƒë∆°n h√†ng.");
                    loadingOrdersElement.classList.add('hidden');
                    noOrdersElement.innerHTML = '<p class="text-gray-600">Vui l√≤ng <a href="/Customer/templates/login.html" class="text-indigo-600 hover:underline">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem ƒë∆°n h√†ng.</p>';
                    noOrdersElement.classList.remove('hidden');
                    return;
                }

                const url = `${API_BASE_URL}/Orders/my-orders?${params.toString()}`;

                try {
                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                    loadingOrdersElement.classList.add('hidden');

                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                            window.location.href = "/Customer/templates/login.html";
                            return;
                        }
                        const errorText = await response.text();
                        throw new Error(`L·ªói ${response.status}: ${errorText || "Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng."}`);
                    }
                    const data = await response.json();
                    console.log(data)

                    if (data.items && data.items.length > 0) {
                        renderOrderList(data.items);
                        updatePaginationUI(data);
                        paginationContainer.classList.remove('hidden');
                    } else {
                        noOrdersElement.classList.remove('hidden');
                        paginationContainer.classList.add('hidden');
                    }
                    const mainContentElement = document.getElementById('mainContent');
                    if (mainContentElement) {
                        mainContentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }

                } catch (error) {
                    console.error('L·ªói khi t·∫£i ƒë∆°n h√†ng c·ªßa kh√°ch h√†ng:', error);
                    orderListContainer.innerHTML = `<p class="text-red-500 text-center p-4 bg-red-100 rounded-md">${error.message}</p>`;
                    loadingOrdersElement.classList.add('hidden');
                    paginationContainer.classList.add('hidden');
                }
            }

            function renderOrderList(orders) { // orders gi·ªù l√† m·ªôt m·∫£ng c√°c OrderDto
                orderListContainer.innerHTML = '';
                orders.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'bg-white rounded-lg shadow-md mb-6 overflow-hidden';

                    const currentStatus = order.status;
                    const statusClass = getStatusClass(currentStatus);

                    let representativeShopName = "ShopX Mall";
                    let representativeSellerID = null;
                    if (order.items && order.items.length > 0 && order.items[0].shopName && order.items[0].shopName !== "N/A") {
                        const allSameShop = order.items.every(item => item.shopName === order.items[0].shopName);
                        if (allSameShop) {
                            representativeShopName = order.items[0].shopName;
                            representativeSellerID = order.items[0].sellerID
                        } else {
                            representativeShopName = "Nhi·ªÅu ng∆∞·ªùi b√°n";
                        }
                    }

                    let orderHeaderHTML = `
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center">
                    <i class="fas fa-store text-indigo-600 mr-2"></i>
                    <a href="https://127.0.0.1:5500/Customer/templates/seller-profile.html?sellerId=${representativeSellerID}" class="font-semibold text-gray-700 text-sm hover:text-blue-500 hover:underline">${representativeShopName}</a>
                </div>
                <div class="text-xs font-medium uppercase ${statusClass === 'status-da-giao' ? 'text-green-600' : (statusClass === 'status-da-huy' ? 'text-red-600' : 'text-orange-500')}">
                    ${currentStatus}
                </div>
            </div>
        `;

                    let itemsHtml = '';
                    if (order.items && order.items.length > 0) {
                        order.items.forEach(item => {
                            itemsHtml += `
                    <div class="flex items-start p-4 border-b border-gray-100 last:border-b-0">
                        <img src="${getImageUrl(item.productImageURL)}" alt="${item.productName}" class="w-16 h-16 object-cover rounded mr-4 flex-shrink-0">
                        <div class="flex-grow">
                            <a href="/Customer/templates/product-detail.html?productId=${item.productID}" 
                            class="mb-2 text-lg text-gray-800 leading-tight hover:text-indigo-600 rounded-full ${!item.isActive ? 'no-event' : ''}">
                            ${item.productName}
                            ${!item.isActive ? `<span class="text-xs font-medium px-3 py-1 ml-8 bg-gray-500 rounded-full w-24 text-center text-white">ƒê√£ ng·ª´ng b√°n</span>` : ''}
                            </a>
                            <p class="text-sm text-gray-500">Ph√¢n lo·∫°i h√†ng: ${item.categoryName}</p>
                            <p class="text-xs text-gray-500">S·ªë l∆∞·ª£ng: x${item.quantity}</p>
                            ${item.shopName && item.shopName !== "N/A" && representativeShopName === "Nhi·ªÅu ng∆∞·ªùi b√°n" ? `<p class="text-xs text-gray-500">Shop: ${item.shopName}</p>` : ''}
                        </div>
                        <div class="text-sm text-right ml-4 flex-shrink-0">
                            <span class="text-indigo-600 font-medium">${formatCurrency(item.unitPrice * item.quantity)}</span>
                        </div>
                    </div>
                `;
                        });
                    } else {
                        itemsHtml = '<p class="p-4 text-sm text-gray-500">Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng n√†y.</p>';
                    }

                    // --- Footer: Th√™m n√∫t H·ªßy ƒë∆°n h√†ng n·∫øu tr·∫°ng th√°i l√† "Ch·ªù x√°c nh·∫≠n", b·ªè n√∫t Mua l·∫°i ---
                    let orderFooterHTML = `
            <div class="p-4 bg-gray-50">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm text-gray-600 mr-2">${date(order.orderDate)}</span>
                    <div>
                        <span class="text-sm text-gray-600 mr-2">Th√†nh ti·ªÅn:</span>
                        <span class="text-xl font-bold text-red-500">${formatCurrency(order.totalPayment)}</span>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-end items-center gap-2">
                    <!-- N√∫t y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn -->
                    ${order.status === ORDER_STATUSES.DA_GIAO && order?.orderDate && getDateDifference(order.orderDate) < 3 ? `
                        <button onclick="customerRequestReturn(${order.orderID})" class="customer-return-request-btn w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors">
                            <i class="fas fa-undo-alt mr-2"></i> Y√™u c·∫ßu tr·∫£ h√†ng/ ho√†n ti·ªÅn
                        </button>` : ''
                        }
                    <!-- N√∫t H·ªßy ƒë∆°n h√†ng -->
                    ${order.status === ORDER_STATUSES.CHO_XAC_NHAN ? `
                        <button onclick="customerCancelOrder(${order.orderID})" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white border border-red-500 px-4 py-2 rounded-sm text-sm font-medium transition-colors">
                            <i class="fas fa-times-circle mr-2"></i>H·ªßy ƒë∆°n h√†ng
                        </button>
                    ` : ''}
                    <a href="/Customer/templates/order-detail.html?id=${order.orderID}" 
                       class="w-full sm:w-auto text-center bg-white hover:bg-gray-100 text-indigo-600 border border-indigo-300 px-4 py-2 rounded-sm text-sm font-medium transition-colors">
                       Xem Chi Ti·∫øt ƒê∆°n
                    </a>
                </div>
            </div>
        `;

                    orderCard.innerHTML = orderHeaderHTML + itemsHtml + orderFooterHTML;
                    orderListContainer.appendChild(orderCard);
                });
            }

            

            async function fetchProductDetails(productIdParam) {
                try {
                    console.log(`üîç Fetching product details for ID: ${productIdParam}`);
                    const response = await fetch(`${API_BASE_URL}/Products/Customer/${productIdParam}`); // S·ª≠ d·ª•ng endpoint customer

                    if (!response.ok) {
                        // ... (X·ª≠ l√Ω l·ªói fetchProductDetails gi·ªØ nguy√™n) ...
                        let errorMessage = `L·ªói ${response.status}: Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m.`;
                        if (response.status === 404) errorMessage = 'S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ ng·ª´ng b√°n.';
                        else if (response.status === 403) errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p s·∫£n ph·∫©m n√†y.';
                        else if (response.status === 500) errorMessage = 'L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.';
                        else {
                            try { const errData = await response.json(); errorMessage = errData.message || errorMessage; } catch (e) { /* ignore */ }
                        }
                        throw new Error(errorMessage);
                    }

                    const productData = await response.json();
                    console.log(`‚úÖ Product data received:`, productData);

                    if (!productData.isActive) { // Ki·ªÉm tra th√™m ·ªü client
                        throw new Error('S·∫£n ph·∫©m n√†y hi·ªán kh√¥ng c√≤n kinh doanh.');
                    }

                    currentProductData = productData;
                    displayProductDetails(currentProductData);

                    // SAU KHI HI·ªÇN TH·ªä CHI TI·∫æT S·∫¢N PH·∫®M CH√çNH, T·∫¢I S·∫¢N PH·∫®M LI√äN QUAN
                    if (currentProductData && typeof currentProductData.categoryID === 'number') {
                        fetchRelatedProducts(currentProductData.categoryID, currentProductData.productID);
                    }

                } catch (error) {
                    console.error('‚ùå Error fetching product details:', error);
                    const productDetailContainer = document.getElementById('productDetailContainer');
                    if (productDetailContainer) {
                        productDetailContainer.innerHTML = `<p class="text-center text-red-500 col-span-full py-8 text-lg">${error.message}</p>`;
                    }
                    // ·∫®n c√°c ph·∫ßn kh√¥ng c·∫ßn thi·∫øt n·∫øu l·ªói
                    const descriptionSection = document.querySelector('.mt-12.pt-8.border-t');
                    if (descriptionSection) descriptionSection.style.display = 'none';
                    const relatedSection = document.querySelector('section.mt-12.pt-8.border-t');
                    if (relatedSection) relatedSection.style.display = 'none';
                }
            }

            function displayProductDetails(product) {
                // ... (H√†m displayProductDetails gi·ªØ nguy√™n nh∆∞ c·∫≠u ƒë√£ cung c·∫•p) ...
                if (!product) return;

                console.log('üé® Displaying product details:', product);

                document.title = `${product.productName || 'Chi ti·∫øt s·∫£n ph·∫©m'} - ShopX`;

                if (productIdHiddenEl) productIdHiddenEl.value = product.productID;
                if (mainProductImage) mainProductImage.src = getProductImageUrl(product.imageURL);
                if (productNameEl) productNameEl.textContent = product.productName || 'N/A';
                if (productPriceEl) productPriceEl.textContent = formatCurrency(product.price);

                if (sellerStoreNameEl) sellerStoreNameEl.textContent = product.sellerStoreName || 'Kh√¥ng r√µ';
                if (document.getElementById('sellerLink')) {
                    document.getElementById('sellerLink').href = `seller-profile.html?id=${product.sellerID}`;
                }

                if (categoryNameDetailEl) categoryNameDetailEl.textContent = product.categoryName || 'Kh√¥ng r√µ';
                if (categoryLinkDetailEl) {
                    categoryLinkDetailEl.href = `category-products.html?categoryId=${product.categoryID}`;
                }

                if (stockQuantityInfoEl) stockQuantityInfoEl.textContent = product.stockQuantity || 0;
                if (quantityInput) {
                    quantityInput.max = product.stockQuantity || 1;
                    if (product.stockQuantity < 1) {
                        quantityInput.value = 0;
                        quantityInput.min = 0;
                        quantityInput.disabled = true;
                        if (addToCartBtn) {
                            addToCartBtn.disabled = true;
                            addToCartBtn.innerHTML = '<i class="fas fa-times-circle mr-2"></i>H·∫øt h√†ng';
                            addToCartBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            addToCartBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        }
                        stockQuantityInfoEl.textContent = "H·∫øt h√†ng";
                    } else {
                        quantityInput.value = 1;
                        quantityInput.min = 1;
                        quantityInput.disabled = false;
                        if (addToCartBtn) {
                            addToCartBtn.disabled = false;
                            addToCartBtn.innerHTML = '<i class="fas fa-cart-plus mr-2"></i>Th√™m v√†o gi·ªè h√†ng';
                            addToCartBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            addToCartBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        }
                    }
                }

                if (productDescriptionEl) {
                    const description = product.description || 'Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt cho s·∫£n ph·∫©m n√†y.';
                    productDescriptionEl.innerHTML = description.replace(/\n/g, '<br>');
                }

                if (breadcrumbCategoryNameEl) breadcrumbCategoryNameEl.textContent = product.categoryName || 'Danh m·ª•c';
                if (breadcrumbProductNameEl) breadcrumbProductNameEl.textContent = product.productName || 'S·∫£n ph·∫©m';
                if (breadcrumbCategoryLinkEl) {
                    breadcrumbCategoryLinkEl.href = `category-products.html?categoryId=${product.categoryID}`;
                }

                console.log('‚úÖ Product details displayed successfully');
            }

            // --- H√ÄM M·ªöI ƒê·ªÇ T·∫¢I V√Ä HI·ªÇN TH·ªä S·∫¢N PH·∫®M LI√äN QUAN ---
            async function fetchRelatedProducts(categoryId, currentProductId) {
                if (!relatedProductsGridEl || !categoryId) return;

                relatedProductsGridEl.innerHTML = '<p class="col-span-full text-center text-gray-500">ƒêang t·∫£i s·∫£n ph·∫©m li√™n quan...</p>';
                const pageSize = 5; // S·ªë l∆∞·ª£ng s·∫£n ph·∫©m li√™n quan mu·ªën hi·ªÉn th·ªã

                try {
                    const response = await fetch(`${API_BASE_URL}/Products/Category/${categoryId}?pageNumber=1&pageSize=${pageSize}`);
                    if (!response.ok) {
                        throw new Error(`Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m li√™n quan (L·ªói ${response.status})`);
                    }
                    const pagedResult = await response.json(); // API c·ªßa c·∫≠u c√≥ th·ªÉ tr·∫£ v·ªÅ PagedResult<ProductSummaryDto>

                    if (pagedResult && pagedResult.items && pagedResult.items.length > 0) {
                        relatedProductsGridEl.innerHTML = ''; // X√≥a th√¥ng b√°o "ƒêang t·∫£i..."
                        let countDisplayed = 0;
                        pagedResult.items.forEach(product => {
                            // Ch·ªâ hi·ªÉn th·ªã n·∫øu kh√°c s·∫£n ph·∫©m hi·ªán t·∫°i V√Ä c√≤n active V√Ä c√≤n h√†ng
                            if (product.productID !== currentProductId && product.isActive && product.stockQuantity > 0 && countDisplayed < pageSize) {
                                relatedProductsGridEl.innerHTML += renderRelatedProductItem(product);
                                countDisplayed++;
                            }
                        });
                        if (countDisplayed === 0) {
                            relatedProductsGridEl.innerHTML = '<p class="col-span-full text-center text-gray-500">Kh√¥ng c√≥ s·∫£n ph·∫©m li√™n quan n√†o.</p>';
                        }
                    } else {
                        relatedProductsGridEl.innerHTML = '<p class="col-span-full text-center text-gray-500">Kh√¥ng c√≥ s·∫£n ph·∫©m li√™n quan n√†o.</p>';
                    }
                } catch (error) {
                    console.error('L·ªói t·∫£i s·∫£n ph·∫©m li√™n quan:', error);
                    relatedProductsGridEl.innerHTML = `<p class="col-span-full text-center text-red-500">L·ªói: ${error.message}</p>`;
                }
            }

            // --- H√ÄM M·ªöI ƒê·ªÇ RENDER M·ªòT S·∫¢N PH·∫®M LI√äN QUAN ---
            // Gi·∫£ s·ª≠ s·∫£n ph·∫©m li√™n quan l√† ProductSummaryDto ho·∫∑c c√≥ c√°c thu·ªôc t√≠nh t∆∞∆°ng t·ª±
            function renderRelatedProductItem(product) {
                const imageUrl = getProductImageUrl(product.imageURL); // T√°i s·ª≠ d·ª•ng h√†m getProductImageUrl
                const productUrl = `product-detail.html?productId=${product.productID}`;

                return `
            <div class="related-product-card bg-white rounded-lg shadow-md overflow-hidden transition-all hover:shadow-lg">
                <a href="${productUrl}" class="block">
                    <img src="${imageUrl}" alt="${product.productName}" class="w-full h-40 object-cover">
                </a>
                <div class="p-3">
                    <h3 class="text-sm font-semibold text-gray-800 mb-1 truncate" title="${product.productName}">
                        <a href="${productUrl}" class="hover:text-blue-600">${product.productName}</a>
                    </h3>
                    <p class="text-xs text-gray-500 mb-2 truncate">
                        ${product.categoryName || 'N/A'} <!-- Gi·∫£ s·ª≠ DTO c√≥ CategoryName -->
                    </p>
                    <div class="flex justify-between items-center">
                        <span class="text-red-600 font-bold text-sm">${formatCurrency(product.price)}</span>
                        <!-- C√≥ th·ªÉ th√™m n√∫t "Xem" nh·ªè ho·∫∑c icon gi·ªè h√†ng n·∫øu mu·ªën -->
                    </div>
                </div>
            </div>
        `;
            }

            function updatePaginationUI(data) {
                if (data && data.totalCount > 0) {
                    paginationInfoElement.classList.remove('hidden');
                    paginationContainer.classList.remove('hidden'); // Ensure pagination container is visible
                    currentPageInfoElement.textContent = data.pageNumber;
                    totalPagesInfoElement.textContent = data.totalPages;
                    totalItemsInfoElement.textContent = data.totalCount;
                    pageInput.value = data.pageNumber;
                    pageInput.max = data.totalPages;

                    prevPageBtn.disabled = !data.hasPreviousPage;
                    nextPageBtn.disabled = !data.hasNextPage;
                    goToPageBtn.disabled = (data.totalPages <= 1);
                } else {
                    paginationInfoElement.classList.add('hidden');
                    paginationContainer.classList.add('hidden'); // Hide if no data
                    currentPageInfoElement.textContent = '0';
                    totalPagesInfoElement.textContent = '0';
                    totalItemsInfoElement.textContent = '0';
                    pageInput.value = '1';
                    pageInput.max = '1';
                    [prevPageBtn, nextPageBtn, goToPageBtn].forEach(btn => btn.disabled = true);
                }
            }

            filterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                fetchCustomerOrders(1);
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) fetchCustomerOrders(currentPage - 1);
            });
            nextPageBtn.addEventListener('click', () => {
                const totalPages = parseInt(totalPagesInfoElement.textContent) || 1;
                if (currentPage < totalPages) fetchCustomerOrders(currentPage + 1);
            });
            goToPageBtn.addEventListener('click', () => {
                const targetPage = parseInt(pageInput.value);
                const totalPages = parseInt(totalPagesInfoElement.textContent) || 1;
                if (targetPage >= 1 && targetPage <= totalPages && targetPage !== currentPage) {
                    fetchCustomerOrders(targetPage);
                } else if (targetPage !== currentPage) {
                    alert(`Vui l√≤ng nh·∫≠p s·ªë trang h·ª£p l·ªá t·ª´ 1 ƒë·∫øn ${totalPages}.`);
                    pageInput.value = currentPage;
                }
            });
            pageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    goToPageBtn.click();
                }
            });

            // Initial Load
            if (checkAuthTokenForPage()) { // H√†m n√†y ƒë√£ c√≥ trong index.js
                populateStatusFilter();
                fetchCustomerOrders(currentPage);
            } else {
                loadingOrdersElement.classList.add('hidden');
                noOrdersElement.innerHTML = '<p class="text-gray-600">Vui l√≤ng <a href="/Customer/templates/login.html" class="text-indigo-600 hover:underline">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem ƒë∆°n h√†ng.</p>';
                noOrdersElement.classList.remove('hidden');
                paginationContainer.classList.add('hidden');
            }
        }

        // ƒê·ª£i cho ƒë·∫øn khi c√°c script kh√°c (index.js, components.js) c√≥ th·ªÉ ƒë√£ ch·∫°y xong
        // v√† DOMContentLoaded c·ªßa ch√∫ng ƒë√£ ho√†n t·∫•t.
        // M·ªôt c√°ch ƒë∆°n gi·∫£n l√† d√πng setTimeout, nh∆∞ng kh√¥ng l√Ω t∆∞·ªüng.
        // C√°ch t·ªët h∆°n l√† components.js ph√°t ra m·ªôt s·ª± ki·ªán t√πy ch·ªânh khi n√≥ load xong.
        // Ho·∫∑c, ƒë·∫£m b·∫£o th·ª© t·ª± load script l√† index.js -> components.js -> script c·ªßa trang n√†y.

        // V√¨ components.js load b·∫•t ƒë·ªìng b·ªô, ch√∫ng ta c·∫ßn ƒë·∫£m b·∫£o n√≥ ho√†n th√†nh
        // tr∆∞·ªõc khi g·ªçi initializeCustomerOrdersPage.
        // C√°ch ƒë∆°n gi·∫£n l√† ch·ªù m·ªôt ch√∫t.
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCustomerOrdersPage);
        } else {
            // DOMContentLoaded ƒë√£ x·∫£y ra, nh∆∞ng components.js c√≥ th·ªÉ v·∫´n ƒëang load
            // N·∫øu components.js kh√¥ng c√≥ c∆° ch·∫ø b√°o hi·ªáu ho√†n th√†nh, d√πng setTimeout
            // l√† m·ªôt gi·∫£i ph√°p t·∫°m th·ªùi.
            setTimeout(initializeCustomerOrdersPage, 200); // Ch·ªù 200ms ƒë·ªÉ components load xong
        }
    </script>
    
</body>

</html>